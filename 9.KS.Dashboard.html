<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knotte Studios — Dashboard</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#12141b; --text:#f4f6ff; --muted:#b7bdd6;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff; --accent2:#20d3ff;
      --good:#2be4a7; --warn:#ffcc66;
      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1000px 600px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
                  radial-gradient(900px 500px at 92% 10%, rgba(32,211,255,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:28px 18px 80px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px 0;
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:900;}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2));}
    a{color:inherit; text-decoration:none}
    .pill{border:1px solid var(--line); background:rgba(255,255,255,.03); padding:10px 12px; border-radius:999px; color:var(--muted); font-weight:750;}
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-top: 12px;
    }
    h1{margin:0 0 8px; font-size:26px; letter-spacing:-.02em}
    p{margin:0; color:var(--muted); line-height:1.55}
    .grid{
      display:grid;
      grid-template-columns: repeat(12,1fr);
      gap: 14px;
      margin-top: 14px;
    }
    .card{
      grid-column: span 6;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 16px;
    }
    .card h2{margin:0 0 8px; font-size:18px}
    .kv{font-family:var(--mono); font-size:.9rem; color:rgba(183,189,214,.9); line-height:1.6}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px}
    button{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071018;
      font-weight:900;
      padding:12px 14px;
      border-radius: 12px;
      cursor:pointer;
      flex:1;
      min-width: 180px;
    }
    button.secondary{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    .status{
      margin-top: 10px;
      display:inline-flex; gap:10px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .badge{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(255,204,102,.14);
    }
    .badge.good{background:var(--good); box-shadow: 0 0 0 4px rgba(43,228,167,.12);}
    .warnBox{
      margin-top: 12px;
      border:1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.08);
      padding: 10px 12px;
      border-radius: 12px;
      color: rgba(255,245,210,.92);
      display:none;
    }
    @media (max-width: 860px){
      .card{grid-column: span 12;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="line-height:1.1;">Knotte Studios</div>
          <div style="color:var(--muted); font-weight:750; font-size:.88rem;">Dashboard</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="pill" href="9.KS.Home.html">Home</a>
        <a class="pill" href="9.KS.Editor.html">Editor</a>
        <a class="pill" href="9.KS.SignUp.html" id="signOutLink">Sign out</a>
      </div>
    </div>

    <div class="panel">
      <h1>Your wedding site</h1>
      <p>Manage your template, edit content, and publish/export your page.</p>

      <div class="status" id="statusPill">
        <span class="badge" id="statusBadge"></span>
        <span id="statusText">Status</span>
      </div>

      <div class="warnBox" id="warnBox"></div>

      <div class="grid">
        <div class="card">
          <h2>Account</h2>
          <div class="kv" id="accountKV"></div>
          <div class="row">
            <button type="button" class="secondary" id="changeTemplateBtn">Change template</button>
            <button type="button" id="openEditorBtn">Open editor</button>
          </div>
        </div>

        <div class="card">
          <h2>Publishing</h2>
          <div class="kv" id="publishKV"></div>
          <div class="row">
            <button type="button" class="secondary" id="exportBtn">Export HTML</button>
            <button type="button" id="publishBtn">Publish (stub)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function $(id){ return document.getElementById(id); }

    function getSession(){
      return localStorage.getItem("KS_SESSION_EMAIL") || "";
    }
    function clearSession(){
      localStorage.removeItem("KS_SESSION_EMAIL");
    }

    function getUserProfile(email){
      try{ return JSON.parse(localStorage.getItem("KS_USER_" + email) || "null"); }
      catch(e){ return null; }
    }
    function setUserProfile(email, profile){
      localStorage.setItem("KS_USER_" + email, JSON.stringify(profile));
    }

    function getSelectedTemplate(){
      return localStorage.getItem("KS_SELECTED_TEMPLATE") || "";
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildSiteHTML(profile){
      // Same token style used in previews
      let html = "";
      const t = profile.templateId || "t1-elegant-night";
      const flavor =
        t.includes("garden") ? "garden" :
        t.includes("minimal") ? "minimal" : "elegant";

      html = getTemplateHTML(flavor);

      const f = profile.fields || {};
      const replaceMap = {
        "{{COUPLE_NAMES}}": f.coupleNames || "Alex & Jamie",
        "{{WEDDING_DATE}}": f.weddingDate || "October 10, 2026",
        "{{WEDDING_LOCATION}}": f.weddingLocation || "Springfield, MO",
        "{{WELCOME_MESSAGE}}": f.welcomeMessage || "We’re so excited to celebrate with you.",
        "{{RSVP_URL}}": f.rsvpUrl || "https://example.com/rsvp",
        "{{SCHEDULE_TEXT}}": f.scheduleText || "Ceremony • Cocktail Hour • Reception",
        "{{DETAILS_TEXT}}": f.detailsText || "Dress code, parking, lodging, etc.",
        "{{REGISTRY_TEXT}}": f.registryText || "Registry info goes here.",
        "{{STORY_TEXT}}": f.storyText || "Our story goes here."
      };
      Object.keys(replaceMap).forEach(k => {
        html = html.split(k).join(replaceMap[k]);
      });
      return html;
    }

    function getTemplateHTML(flavor){
      const base = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{COUPLE_NAMES}} — Wedding</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141b; --text:#f4f6ff; --muted:#b7bdd6;
      --line:rgba(255,255,255,.10); --accent:#7c5cff; --accent2:#20d3ff;
      --radius:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:28px 18px 70px;}
    header{border:1px solid var(--line); border-radius:var(--radius); padding:22px; background:rgba(255,255,255,.03);}
    h1{margin:0 0 6px; font-size:34px; letter-spacing:-.02em;}
    .sub{margin:0; color:var(--muted); line-height:1.55;}
    .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:14px; margin-top:16px;}
    .card{grid-column:span 6; border:1px solid var(--line); border-radius:var(--radius); padding:16px; background:rgba(255,255,255,.03);}
    .card h2{margin:0 0 8px; font-size:18px}
    .card p{margin:0; color:var(--muted); line-height:1.5;}
    .btn{
      display:inline-block; margin-top:12px;
      padding:10px 12px; border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#061018; font-weight:900; text-decoration:none;
    }
    footer{margin-top:22px; color:var(--muted); font-size:14px}
    @media (max-width:720px){ .card{grid-column:span 12;} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>{{COUPLE_NAMES}}</h1>
      <p class="sub">{{WEDDING_DATE}} • {{WEDDING_LOCATION}}</p>
      <p class="sub" style="margin-top:10px;">{{WELCOME_MESSAGE}}</p>
      <a class="btn" href="{{RSVP_URL}}">RSVP</a>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Schedule</h2>
        <p>{{SCHEDULE_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Details</h2>
        <p>{{DETAILS_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Registry</h2>
        <p>{{REGISTRY_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Our Story</h2>
        <p>{{STORY_TEXT}}</p>
      </div>
    </div>

    <footer>Hosted by Knotte Studios</footer>
  </div>
</body>
</html>`;

      if(flavor === "garden"){
        return base.replaceAll("#0b0c10","#07130f")
                   .replaceAll("#12141b","#0c1c16")
                   .replaceAll("#7c5cff","#7cffb0")
                   .replaceAll("#20d3ff","#88e8ff");
      }
      if(flavor === "minimal"){
        return base.replaceAll("--bg:#0b0c10; --card:#12141b;","--bg:#0b0c10; --card:#0e1016;")
                   .replaceAll("linear-gradient(135deg,var(--accent),var(--accent2))","linear-gradient(135deg,#ffffff,#b7bdd6)")
                   .replaceAll("color:#061018;","color:#0b0c10;");
      }
      return base;
    }

    // Init
    const email = getSession();
    if(!email){
      window.location.href = "9.KS.SignUp.html";
    }

    const profile = getUserProfile(email);
    if(!profile){
      clearSession();
      window.location.href = "9.KS.SignUp.html";
    }

    // Keep selected template synced
    if(profile.templateId){
      localStorage.setItem("KS_SELECTED_TEMPLATE", profile.templateId);
    }

    const slug = profile.slug || "our-wedding";
    const siteUrlPath = "https://knottestudios.com/sites/" + encodeURIComponent(slug) + "/";

    $("accountKV").innerHTML =
      "Email: <strong>" + escapeHTML(email) + "</strong><br/>" +
      "Template: <strong>" + escapeHTML(profile.templateId || getSelectedTemplate() || "none") + "</strong><br/>" +
      "Slug: <strong>" + escapeHTML(slug) + "</strong>";

    $("publishKV").innerHTML =
      "Planned URL (when backend is connected):<br/>" +
      "<strong>" + escapeHTML(siteUrlPath) + "</strong><br/>" +
      "Last edited: <strong>" + new Date(profile.updatedAt || Date.now()).toLocaleString() + "</strong>";

    const hasFields = profile.fields && profile.fields.coupleNames;
    $("statusBadge").className = "badge " + (hasFields ? "good" : "");
    $("statusText").textContent = hasFields ? "Ready to export" : "Needs editing";
    if(!hasFields){
      $("warnBox").style.display = "block";
      $("warnBox").textContent = "Open the editor to add your wedding details, then export.";
    }

    $("openEditorBtn").addEventListener("click", () => {
      window.location.href = "9.KS.Editor.html";
    });

    $("changeTemplateBtn").addEventListener("click", () => {
      window.location.href = "9.KS.Home.html#templates";
    });

    $("exportBtn").addEventListener("click", () => {
      const html = buildSiteHTML(profile);
      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "index.html";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 4000);
      alert("Exported! Upload the index.html anywhere for instant hosting.");
    });

    $("publishBtn").addEventListener("click", async () => {
      // STUB: This is where your real backend would publish the HTML to /sites/{slug}/index.html
      // Example future call:
      // await fetch("/api/publish", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({slug, html})});

      alert("Publish is a stub in this MVP. Export works right now.\n\nNext step: connect a backend endpoint to save and serve /sites/{slug}/index.html.");
    });

    $("signOutLink").addEventListener("click", (e) => {
      e.preventDefault();
      clearSession();
      window.location.href = "9.KS.SignUp.html";
    });
  </script>
</body>
</html>
