<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knotte Studios — Editor</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#12141b; --text:#f4f6ff; --muted:#b7bdd6;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff; --accent2:#20d3ff;
      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1000px 600px at 20% -10%, rgba(124,92,255,.35), transparent 55%),
                  radial-gradient(900px 500px at 92% 10%, rgba(32,211,255,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:22px 16px 70px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:10px 0 16px;
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:900;}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2));}
    .pill{border:1px solid var(--line); background:rgba(255,255,255,.03); padding:10px 12px; border-radius:999px; color:var(--muted); font-weight:750;}
    .layout{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .panelHead strong{letter-spacing:-.01em}
    .panelBody{padding: 14px}
    label{display:block; margin:10px 0 6px; color:var(--muted); font-weight:800}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
      font-weight:700;
      font-family: var(--sans);
    }
    textarea{min-height: 92px; resize: vertical;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px}
    button{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071018;
      font-weight:900;
      padding:12px 14px;
      border-radius: 12px;
      cursor:pointer;
      flex:1;
      min-width: 160px;
    }
    button.secondary{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    .meta{
      margin-top: 10px;
      border-top:1px solid var(--line);
      padding-top: 10px;
      color: rgba(183,189,214,.9);
      font-family: var(--mono);
      font-size: .86rem;
      line-height: 1.55;
    }
    .previewWrap{
      height: calc(100vh - 170px);
      min-height: 520px;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background: #0b0c10;
    }
    .warn{
      margin-top: 10px;
      border:1px solid rgba(255,77,109,.35);
      background: rgba(255,77,109,.08);
      color: rgba(255,240,245,.9);
      padding: 10px 12px;
      border-radius: 12px;
      display:none;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
      .previewWrap{height: 68vh; min-height: 420px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="line-height:1.1;">Knotte Studios</div>
          <div style="color:var(--muted); font-weight:750; font-size:.88rem;">Editor</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="pill" href="9.KS.Home.html">Home</a>
        <a class="pill" href="9.KS.Dashboard.html">Dashboard</a>
        <a class="pill" href="9.KS.SignUp.html" id="signOutLink">Sign out</a>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="panelHead">
          <strong>Site content</strong>
          <span class="pill" id="tplPill">Template: —</span>
        </div>
        <div class="panelBody">
          <div class="warn" id="warn"></div>

          <label for="coupleNames">Couple names</label>
          <input id="coupleNames" type="text" placeholder="Alex & Jamie" />

          <label for="weddingDate">Wedding date</label>
          <input id="weddingDate" type="text" placeholder="October 10, 2026" />

          <label for="weddingLocation">Location</label>
          <input id="weddingLocation" type="text" placeholder="Springfield, MO" />

          <label for="welcomeMessage">Welcome message</label>
          <textarea id="welcomeMessage" placeholder="We’re so excited to celebrate with you…"></textarea>

          <label for="rsvpUrl">RSVP link</label>
          <input id="rsvpUrl" type="url" placeholder="https://example.com/rsvp" />

          <label for="scheduleText">Schedule</label>
          <textarea id="scheduleText" placeholder="4:00 PM Ceremony • 5:30 PM Cocktail Hour • 7:00 PM Reception"></textarea>

          <label for="detailsText">Details</label>
          <textarea id="detailsText" placeholder="Dress code, parking, lodging, etc."></textarea>

          <label for="registryText">Registry</label>
          <textarea id="registryText" placeholder="We’re registered at…"></textarea>

          <label for="storyText">Our story</label>
          <textarea id="storyText" placeholder="We met…"></textarea>

          <div class="row">
            <button type="button" id="saveBtn">Save</button>
            <button type="button" class="secondary" id="exportBtn">Export HTML</button>
          </div>

          <div class="row">
            <button type="button" class="secondary" id="changeTemplateBtn">Change template</button>
            <button type="button" id="publishBtn">Publish (stub)</button>
          </div>

          <div class="meta" id="meta"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <strong>Live preview</strong>
          <span class="pill" id="slugPill">URL: —</span>
        </div>
        <div class="previewWrap">
          <iframe id="previewFrame" title="Live preview"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    function $(id){ return document.getElementById(id); }

    function getSession(){
      return localStorage.getItem("KS_SESSION_EMAIL") || "";
    }
    function clearSession(){
      localStorage.removeItem("KS_SESSION_EMAIL");
    }

    function getUserProfile(email){
      try{ return JSON.parse(localStorage.getItem("KS_USER_" + email) || "null"); }
      catch(e){ return null; }
    }
    function setUserProfile(email, profile){
      localStorage.setItem("KS_USER_" + email, JSON.stringify(profile));
    }

    function getSelectedTemplate(){
      return localStorage.getItem("KS_SELECTED_TEMPLATE") || "";
    }
    function setSelectedTemplate(id){
      localStorage.setItem("KS_SELECTED_TEMPLATE", id);
    }

    function setWarn(msg){
      const el = $("warn");
      el.textContent = msg || "";
      el.style.display = msg ? "block" : "none";
    }

    function getTemplateHTML(flavor){
      const base = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{COUPLE_NAMES}} — Wedding</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141b; --text:#f4f6ff; --muted:#b7bdd6;
      --line:rgba(255,255,255,.10); --accent:#7c5cff; --accent2:#20d3ff;
      --radius:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:28px 18px 70px;}
    header{border:1px solid var(--line); border-radius:var(--radius); padding:22px; background:rgba(255,255,255,.03);}
    h1{margin:0 0 6px; font-size:34px; letter-spacing:-.02em;}
    .sub{margin:0; color:var(--muted); line-height:1.55;}
    .grid{display:grid; grid-template-columns: repeat(12,1fr); gap:14px; margin-top:16px;}
    .card{grid-column:span 6; border:1px solid var(--line); border-radius:var(--radius); padding:16px; background:rgba(255,255,255,.03);}
    .card h2{margin:0 0 8px; font-size:18px}
    .card p{margin:0; color:var(--muted); line-height:1.5;}
    .btn{
      display:inline-block; margin-top:12px;
      padding:10px 12px; border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#061018; font-weight:900; text-decoration:none;
    }
    footer{margin-top:22px; color:var(--muted); font-size:14px}
    @media (max-width:720px){ .card{grid-column:span 12;} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>{{COUPLE_NAMES}}</h1>
      <p class="sub">{{WEDDING_DATE}} • {{WEDDING_LOCATION}}</p>
      <p class="sub" style="margin-top:10px;">{{WELCOME_MESSAGE}}</p>
      <a class="btn" href="{{RSVP_URL}}">RSVP</a>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Schedule</h2>
        <p>{{SCHEDULE_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Details</h2>
        <p>{{DETAILS_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Registry</h2>
        <p>{{REGISTRY_TEXT}}</p>
      </div>
      <div class="card">
        <h2>Our Story</h2>
        <p>{{STORY_TEXT}}</p>
      </div>
    </div>

    <footer>Hosted by Knotte Studios</footer>
  </div>
</body>
</html>`;

      if(flavor === "garden"){
        return base.replaceAll("#0b0c10","#07130f")
                   .replaceAll("#12141b","#0c1c16")
                   .replaceAll("#7c5cff","#7cffb0")
                   .replaceAll("#20d3ff","#88e8ff");
      }
      if(flavor === "minimal"){
        return base.replaceAll("--bg:#0b0c10; --card:#12141b;","--bg:#0b0c10; --card:#0e1016;")
                   .replaceAll("linear-gradient(135deg,var(--accent),var(--accent2))","linear-gradient(135deg,#ffffff,#b7bdd6)")
                   .replaceAll("color:#061018;","color:#0b0c10;");
      }
      return base;
    }

    function buildHTML(templateId, fields){
      const flavor =
        templateId.includes("garden") ? "garden" :
        templateId.includes("minimal") ? "minimal" : "elegant";

      let html = getTemplateHTML(flavor);

      const replaceMap = {
        "{{COUPLE_NAMES}}": fields.coupleNames || "Alex & Jamie",
        "{{WEDDING_DATE}}": fields.weddingDate || "October 10, 2026",
        "{{WEDDING_LOCATION}}": fields.weddingLocation || "Springfield, MO",
        "{{WELCOME_MESSAGE}}": fields.welcomeMessage || "We’re so excited to celebrate with you.",
        "{{RSVP_URL}}": fields.rsvpUrl || "https://example.com/rsvp",
        "{{SCHEDULE_TEXT}}": fields.scheduleText || "Ceremony • Cocktail Hour • Reception",
        "{{DETAILS_TEXT}}": fields.detailsText || "Dress code, parking, lodging, etc.",
        "{{REGISTRY_TEXT}}": fields.registryText || "Registry info goes here.",
        "{{STORY_TEXT}}": fields.storyText || "Our story goes here."
      };

      Object.keys(replaceMap).forEach(k => {
        html = html.split(k).join(replaceMap[k]);
      });
      return html;
    }

    function getFieldsFromForm(){
      return {
        coupleNames: $("coupleNames").value.trim(),
        weddingDate: $("weddingDate").value.trim(),
        weddingLocation: $("weddingLocation").value.trim(),
        welcomeMessage: $("welcomeMessage").value.trim(),
        rsvpUrl: $("rsvpUrl").value.trim(),
        scheduleText: $("scheduleText").value.trim(),
        detailsText: $("detailsText").value.trim(),
        registryText: $("registryText").value.trim(),
        storyText: $("storyText").value.trim()
      };
    }

    function setFormFromFields(f){
      $("coupleNames").value = f.coupleNames || "";
      $("weddingDate").value = f.weddingDate || "";
      $("weddingLocation").value = f.weddingLocation || "";
      $("welcomeMessage").value = f.welcomeMessage || "";
      $("rsvpUrl").value = f.rsvpUrl || "";
      $("scheduleText").value = f.scheduleText || "";
      $("detailsText").value = f.detailsText || "";
      $("registryText").value = f.registryText || "";
      $("storyText").value = f.storyText || "";
    }

    function renderPreview(templateId){
      const fields = getFieldsFromForm();
      const html = buildHTML(templateId, fields);

      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);

      const frame = $("previewFrame");
      const old = frame.dataset.blobUrl;
      frame.src = url;
      frame.dataset.blobUrl = url;

      if(old) setTimeout(() => URL.revokeObjectURL(old), 1000);
    }

    // Init
    const email = getSession();
    if(!email){
      window.location.href = "9.KS.SignUp.html";
    }

    const profile = getUserProfile(email);
    if(!profile){
      clearSession();
      window.location.href = "9.KS.SignUp.html";
    }

    // Template handling
    const chosen = getSelectedTemplate();
    if(chosen && chosen !== profile.templateId){
      profile.templateId = chosen;
      profile.updatedAt = Date.now();
      setUserProfile(email, profile);
    }

    const templateId = profile.templateId || chosen || "t1-elegant-night";
    setSelectedTemplate(templateId);

    const slug = profile.slug || "our-wedding";
    $("tplPill").textContent = "Template: " + templateId;
    $("slugPill").textContent = "URL: /sites/" + slug + "/";

    // Load fields
    const fields = profile.fields || {};
    setFormFromFields(fields);

    // Live preview on input
    const inputs = ["coupleNames","weddingDate","weddingLocation","welcomeMessage","rsvpUrl","scheduleText","detailsText","registryText","storyText"];
    inputs.forEach(id => {
      $(id).addEventListener("input", () => renderPreview(templateId));
    });

    renderPreview(templateId);

    $("saveBtn").addEventListener("click", () => {
      setWarn("");

      const f = getFieldsFromForm();
      if(!f.coupleNames){
        return setWarn("Add the couple names (it shows in the header).");
      }
      profile.fields = f;
      profile.templateId = templateId;
      profile.updatedAt = Date.now();
      setUserProfile(email, profile);

      $("meta").textContent =
        "Saved locally.\n" +
        "Last saved: " + new Date(profile.updatedAt).toLocaleString() + "\n" +
        "Next: Export HTML or connect Publish to your backend.";
      alert("Saved!");
    });

    $("exportBtn").addEventListener("click", () => {
      const f = getFieldsFromForm();
      const html = buildHTML(templateId, f);

      const blob = new Blob([html], {type:"text/html"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "index.html";
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 4000);
      alert("Exported index.html.");
    });

    $("publishBtn").addEventListener("click", async () => {
      // STUB: publish to your domain.
      // Future plan:
      // 1) Generate html = buildHTML(templateId, fields)
      // 2) POST {slug, html} to /api/publish
      // 3) Server saves it to /sites/{slug}/index.html (or your storage + CDN)
      alert("Publish is a stub in this MVP. Export works right now.\n\nWhen you’re ready, I can give you a simple backend + /api/publish endpoint.");
    });

    $("changeTemplateBtn").addEventListener("click", () => {
      window.location.href = "9.KS.Home.html#templates";
    });

    $("signOutLink").addEventListener("click", (e) => {
      e.preventDefault();
      clearSession();
      window.location.href = "9.KS.SignUp.html";
    });

    $("meta").textContent =
      "Editing as: " + email + "\n" +
      "Slug: " + slug + "\n" +
      "Tip: Save after changes to update the dashboard timestamp.";
  </script>
</body>
</html>
