
<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Navigation Hub</title>
  <meta name="color-scheme" content="dark light" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mrs+Saint+Delafield&family=Caramel&family=Annie+Use+Your+Telescope&family=Alumni+Sans+Pinstripe&display=swap" rel="stylesheet">


<!-- ==================================================================================================================
=========================================================START OF STYLE=========================================================
=================================================================================================================== -->

<style>
/* =========================================================
  0) RESET / ACCESSIBILITY
========================================================== */
[hidden]{display:none!important;}
*{box-sizing:border-box;}
.sr-only{
  position:absolute;width:1px;height:1px;
  padding:0;margin:-1px;overflow:hidden;
  clip:rect(0,0,0,0);border:0;
}

/* =========================================================
  1) THEME TOKENS (CSS VARIABLES)
========================================================== */
:root{
  --bg0:#050510;
  --bg1:#070a1c;

  --panel: rgba(255,255,255,.07);
  --panel-2: rgba(255,255,255,.045);
  --border: rgba(255,255,255,.14);

  --text: rgba(255,255,255,.93);
  --muted: rgba(255,255,255,.68);
  --muted2: rgba(255,255,255,.55);

  --accentA:#6d5efc;
  --accentB:#22d3ee;
  --accentC:#ff4fd8;

  --shadow: 0 18px 70px rgba(0,0,0,.55);
  --ring: 0 0 0 3px rgba(34,211,238,.22);
  --ease: cubic-bezier(.2,.8,.2,1);

  --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --serif: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;

  /* Optional ‚Äúroyal display‚Äù font if you load it in <head> */
  --font-royal: ui-serif, Georgia, "Times New Roman", serif;
  --font-soft-royal: var(--serif);

  /* Radius system (single source of truth) */
  --radius-card: 22px;
  --radius-inner: 18px;

  --ink:  rgba(6,7,20,.88);
  --ink2: rgba(10,12,28,.72);
}

/* =========================================================
  2) PAGE / LAYOUT
========================================================== */
body{
  margin:0;
  font-family:var(--sans);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  position:relative;

  background:
    radial-gradient(900px 520px at 15% 10%, color-mix(in oklab, var(--accentB), transparent 78%), transparent 65%),
    radial-gradient(900px 520px at 90% 20%, color-mix(in oklab, var(--accentA), transparent 80%), transparent 60%),
    radial-gradient(1100px 650px at 50% 110%, color-mix(in oklab, var(--accentC), transparent 82%), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

body::before{
  content:"";
  position:fixed;
  inset:-40px;
  pointer-events:none;
  z-index:-1;
  background:
    radial-gradient(closest-side at 25% 25%, rgba(34,211,238,.18), transparent 60%),
    radial-gradient(closest-side at 75% 35%, rgba(109,94,252,.16), transparent 62%),
    radial-gradient(closest-side at 55% 75%, rgba(255,79,216,.14), transparent 60%);
  filter: blur(22px);
  opacity:.9;
  animation:none !important;
}

.wrap{
  max-width: 980px;
  margin:0 auto;
  padding:28px 18px 60px;
}

/* =========================================================
  3) HERO BANNER
========================================================== */
.heroBanner{
  position:relative;
  margin:14px auto 18px;
  border-radius: calc(var(--radius-card) + 6px);
  overflow:hidden;
  isolation:isolate;
  min-height:132px;
  max-width: 980px;

  background:
    radial-gradient(900px 260px at 50% 0%, rgba(255,255,255,.09), transparent 62%),
    radial-gradient(900px 380px at 15% 40%, rgba(34,211,238,.12), transparent 62%),
    radial-gradient(900px 380px at 85% 40%, rgba(109,94,252,.12), transparent 62%),
    linear-gradient(180deg, var(--ink), var(--ink2));

  border: 1px solid rgba(255,255,255,.10);
  box-shadow:
    0 22px 90px rgba(0,0,0,.55),
    inset 0 0 0 1px rgba(255,255,255,.06),
    inset 0 0 60px rgba(109,94,252,.08),
    inset 0 0 120px rgba(34,211,238,.06);

  backdrop-filter: blur(10px);
}

.heroBanner::before{
  content:"";
  position:absolute;
  inset:0;
  padding:1px;
  border-radius: inherit;
  pointer-events:none;
  opacity:.95;
  background: linear-gradient(135deg,
    rgba(34,211,238,.0),
    rgba(34,211,238,.22),
    rgba(109,94,252,.18),
    rgba(255,79,216,.10),
    rgba(34,211,238,.0)
  );
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
}

.heroBanner::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;
  background:
    linear-gradient(120deg, transparent 35%, rgba(255,255,255,.10), transparent 65%),
    radial-gradient(140% 90% at 50% 0%, rgba(255,255,255,.08), transparent 55%),
    linear-gradient(90deg, rgba(0,0,0,.28), transparent 26%, transparent 74%, rgba(0,0,0,.28));
  background-size: 240% 100%, 100% 100%, 100% 100%;
  background-position: -40% 0, 0 0, 0 0;
  animation:none !important;
  opacity:.25 !important;
  mix-blend-mode: normal !important;
}

.heroInner{
  position:relative;
  z-index:1;
  display:grid;
  grid-template-rows:auto 1fr;
  align-content:center;
  padding:22px 22px;
  text-align:center;
}

.heroTop{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.heroCenter{
  display:grid;
  justify-items:center;
  align-content:center;
  max-width:760px;
  margin:0 auto;
}

.heroTitle{
  margin:0 0 6px;
  font-family: var(--font-royal);
  font-weight: 600;
  font-size: clamp(38px, 5vw, 58px);
  line-height:.98;
  letter-spacing:.22em;
  text-transform:uppercase;

  background: linear-gradient(180deg,
    rgba(255,255,255,.98) 0%,
    rgba(255,255,255,.78) 55%,
    rgba(255,255,255,.92) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;

  text-shadow:
    0 10px 42px rgba(0,0,0,.55),
    0 1px 0 rgba(255,255,255,.06);
}



/* Hero ‚Äútrim‚Äù lines */
.heroLaser{
  position:absolute;
  left:0;
  right:0;
  height:1px;
  opacity:.55;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    color-mix(in oklab, var(--accentB), rgba(255,255,255,.62) 45%),
    color-mix(in oklab, var(--accentA), rgba(255,255,255,.62) 45%),
    color-mix(in oklab, var(--accentC), rgba(255,255,255,.58) 40%),
    rgba(255,255,255,0)
  );

  box-shadow:
    0 0 10px rgba(255,255,255,.06),
    0 0 18px rgba(255,255,255,.04);
}
.heroLaserTop{ top:0; }
.heroLaserBottom{ bottom:0; }

/* =========================================================
  4) CARD + TOOLBAR
========================================================== */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius-card);
  box-shadow:var(--shadow);
  overflow:hidden;
  backdrop-filter: blur(10px);
}

.toolbar,
.notebookHead{
  position:relative;
  border-bottom:none !important;
  border-top-left-radius: var(--radius-card);
  border-top-right-radius: var(--radius-card);
  overflow:hidden;

  background:
    radial-gradient(900px 240px at 15% 0%, rgba(34,211,238,.10), transparent 60%),
    radial-gradient(900px 240px at 85% 0%, rgba(109,94,252,.10), transparent 60%),
    radial-gradient(700px 220px at 50% 0%, rgba(255,79,216,.10), transparent 62%),
    rgba(255,255,255,.03) !important;
}

/* Unified header ‚Äúedge trims‚Äù */
.toolbar::before,
.toolbar::after,
.notebookHead::before,
.notebookHead::after{
  content:"";
  position:absolute;
  left:0;
  right:0;
  height:2px;
opacity:.95;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    color-mix(in oklab, var(--accentC), rgba(255,255,255,.72) 45%),
    color-mix(in oklab, var(--accentA), rgba(255,255,255,.72) 45%),
    color-mix(in oklab, var(--accentB), rgba(255,255,255,.65) 40%),
    rgba(255,255,255,0)
  );

  box-shadow:
    0 0 12px rgba(255,79,216,.16),
    0 0 18px rgba(109,94,252,.12),
    0 0 22px rgba(34,211,238,.10);
}
.toolbar::before,.notebookHead::before{ top:0; }
.toolbar::after,.notebookHead::after{ bottom:0; }

/* Toolbar layout: 2-row grid (single version) */
.toolbar{
  display:grid !important;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  grid-template-areas:
    "label actions"
    "search actions";
  gap:10px 12px !important;
  align-items:center;
  padding:16px 16px !important;
  overflow: visible !important; /* allows halo */
}

.toolbarTitle{
  grid-area: label;
  font-size:11px;
  letter-spacing:.30em;
  text-transform:uppercase;
  white-space:nowrap;
  font-weight:600;
  padding-left:2px;
  padding-right:0;
  border-right:none !important;
  opacity:.85;
  color: color-mix(in oklab, var(--accentC), rgba(255,255,255,.92) 82%);
}

.toolbarCenter{
  grid-area: search;
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:flex-start !important;
}

.toolbarRight{
  grid-area: actions;
  display:flex;
  align-items:center;
  gap:8px;
  margin-left:0 !important;
  justify-content:flex-end;
  flex-wrap:wrap;
}

.toolbarCenter .input{
  min-width: 0 !important;
  width: 100% !important;
  max-width: 720px !important;
}

@media (max-width: 560px){
  .toolbar{
    grid-template-columns: 1fr;
    grid-template-areas:
      "label"
      "actions"
      "search";
  }
  .toolbarRight{ justify-content:flex-start; }
}

/* Notebook head: unified 2-row rhythm */
.notebookHead{
  display:grid !important;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  grid-template-areas:
    "label tabs"
    "title tabs";
  gap:12px !important;
  align-items:center;
  padding:16px 16px !important;
}

.kicker{
  grid-area: label;
  font-size:11px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color: color-mix(in oklab, var(--muted), transparent 12%);
  opacity:.95;
}

.notebookTitle{
  grid-area: title;
  font-weight:700;
  letter-spacing:-.02em;
  margin-top:6px;
  color: rgba(255,255,255,.92);
}

.notebookTabs{ grid-area: tabs; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
.notebookBody{ padding:12px; display:grid; gap:12px; }

/* =========================================================
  5) BUTTONS + INPUTS
========================================================== */
.btn{
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  color: rgba(255,255,255,.86);
  padding:7px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
  letter-spacing:.06em;
  font-weight:600;

  display:inline-flex;
  align-items:center;
  gap:8px;
  user-select:none;

  box-shadow:
    0 14px 40px rgba(0,0,0,.30),
    inset 0 1px 0 rgba(255,255,255,.08);

  transition:
    transform .12s var(--ease),
    background .2s var(--ease),
    box-shadow .2s var(--ease),
    border-color .2s var(--ease);
}

.btn:hover{
  transform: translateY(-1px);
  border-color: rgba(34,211,238,.26);
  box-shadow:
    0 18px 55px rgba(0,0,0,.35),
    0 0 0 3px rgba(34,211,238,.10);
}
.btn:active{ transform: translateY(0) scale(.99); }

.input{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  color:var(--text);
  padding:8px 10px;
  border-radius:14px;
  font-size:13px;
  min-width:260px;
  max-width:520px;
  width: min(520px, 100%);
  transition: box-shadow .2s var(--ease), border-color .2s var(--ease);
}

.input:focus{
  outline:none;
  border-color: color-mix(in oklab, var(--accentB), rgba(255,255,255,.16) 40%);
  box-shadow: 0 0 0 3px rgba(34,211,238,.18);
}

select.input{ appearance:none; }

/* Primary Add button halo (single version) */
#addItem{
  position: relative;
  border-color: rgba(34,211,238,.42) !important;
  background: linear-gradient(180deg, rgba(34,211,238,.22), rgba(109,94,252,.12)) !important;
  box-shadow:
    0 18px 65px rgba(0,0,0,.45),
    0 0 0 3px rgba(34,211,238,.18),
    0 0 22px rgba(34,211,238,.25) !important;
}

#addItem::before{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius:999px;
  pointer-events:none;
  background:
    radial-gradient(circle at 35% 35%,
      rgba(255,255,255,.28),
      rgba(34,211,238,.22) 35%,
      rgba(109,94,252,.18) 60%,
      transparent 75%
    );
  filter: blur(10px);
  opacity: .9;
  transition: opacity .2s var(--ease), transform .2s var(--ease);
}

#addItem:hover::before{ opacity: 1; transform: scale(1.02); }
#addItem:active::before{ opacity: .75; transform: scale(.99); }

#addItem:focus-visible{
  outline:none;
  box-shadow:
    0 0 0 3px rgba(34,211,238,.28),
    0 0 28px rgba(34,211,238,.30),
    0 18px 65px rgba(0,0,0,.45) !important;
}

/* =========================================================
  6) TREE / NODES / TILES
========================================================== */
.tree{ padding:12px; display:grid; gap:16px; }

.dropHint{
  padding:10px 12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.22);
  background: rgba(255,255,255,.03);
  color: rgba(255,255,255,.65);
  font-size:12.5px;
  cursor:pointer;
  text-align:left;
}
.dropHint:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.30); }
.dropHint:focus-visible{ outline:none; box-shadow: var(--ring); }

.node{
  position:relative;
  border-radius:var(--radius-inner);
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* accent strips on both edges */
.node[data-accent="1"]::before,
.node[data-accent="1"]::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:6px;
  background: var(--accentStrip, rgba(255,255,255,.35));
  opacity:.95;
  pointer-events:none;
  filter: saturate(1.1);
}
.node[data-accent="1"]::before{ left:0; }
.node[data-accent="1"]::after{ right:0; }

.nodeHeader{
  display:grid;
  grid-template-columns: 1fr auto;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  user-select:none;
  border-bottom:1px solid rgba(255,255,255,.10);
  border-radius:0;
}
.node[data-accent="1"] .nodeHeader,
.node[data-accent="1"] .nodeBody{ padding-left:18px; padding-right:18px; }

.nodeHeaderLeft{ display:flex; align-items:center; gap:12px; min-width:0; }

.twisty{
  width:28px;height:28px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  cursor:pointer;
  flex:0 0 auto;
}
.twisty:hover{ background: rgba(255,255,255,.10); }

.nodeTitle{
  font-weight:750;
  letter-spacing:-.01em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}

.nodeBody{ padding:12px; display:grid; gap:14px; }
.nodeBody > .node{ margin-top:6px; }

.tile{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:default;
  transition: transform .14s var(--ease), background .2s var(--ease), border-color .2s var(--ease);
}
.tile:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.07); }

.tileMain{ flex:1 1 auto; min-width:0; }

.tileTitleLine{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:4px; }
.tileTitle{ font-weight:650; letter-spacing:-.01em; }

.chip{
  font-size:11.5px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  color:var(--muted);
}

.notes{
  margin-top:6px;
  font-size:12.5px;
  color:var(--muted2);
  line-height:1.45;
}

.actions{ display:flex; align-items:center; gap:8px; flex:0 0 auto; margin-left:auto; }

.iconBtn{
  width:36px;height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  cursor:pointer;
  display:grid;
  place-items:center;
  transition: transform .12s var(--ease), background .2s var(--ease), box-shadow .2s var(--ease);
}
.iconBtn:hover{ background: rgba(255,255,255,.10); box-shadow: 0 0 0 3px rgba(109,94,252,.12); }
.iconBtn:active{ transform: translateY(1px); }
.iconBtn:focus-visible{ outline:none; box-shadow: var(--ring); }
.iconBtn.active{
  border-color: rgba(34,211,238,.35);
  box-shadow: 0 0 0 3px rgba(34,211,238,.12);
  background: rgba(34,211,238,.08);
}

.indent{ margin-left:14px; border-left:1px solid rgba(255,255,255,.10); padding-left:12px; }
.node.indent{ background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.025)); }
.node.indent .nodeHeader{ padding:10px 14px; }
.node.indent .nodeTitle{ font-weight:600; opacity:.92; }

[data-container="children"]{ display:grid; gap:14px; }
.tree > [data-container="children"]{ gap:18px; }

.dragHandle{
  width:36px;height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  cursor:grab;
  user-select:none;
  font-family: var(--mono);
  font-size:16px;
  line-height:1;
  opacity:.9;
  transition: transform .12s var(--ease), background .2s var(--ease), box-shadow .2s var(--ease);
}
.dragHandle:hover{ background: rgba(255,255,255,.10); box-shadow: 0 0 0 3px rgba(34,211,238,.12); }
.dragHandle:active{ cursor:grabbing; transform: translateY(1px); }

/* =========================================================
  7) MODAL
========================================================== */
.modalBackdrop{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.55);
  display:grid;
  place-items:center;
  padding:18px;
  z-index:50;
}

.modal{
  width:min(860px, 96vw);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  box-shadow:0 30px 120px rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.modalHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(255,255,255,.10);
}

.modalTitle{ font-weight:700; letter-spacing:-.02em; }
.modalBody{ padding:14px; display:grid; gap:12px; }

.field{ display:grid; gap:6px; }
.field > span{ font-size:12px; color:var(--muted2); }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
@media (max-width:720px){ .grid2{ grid-template-columns: 1fr; } }

.modalActions{ display:flex; align-items:center; gap:10px; padding-top:6px; }

/* =========================================================
  8) DROPDOWN MENU
========================================================== */
.menu{ position:relative; }
.menu > summary{ list-style:none; }
.menu > summary::-webkit-details-marker{ display:none; }

.menuList{
  position:absolute;
  top: calc(100% + 10px);
  right: 0;
  min-width: 190px;
  padding:10px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,12,28,.85);
  backdrop-filter: blur(10px);
  box-shadow: 0 22px 80px rgba(0,0,0,.55);
  display:grid;
  gap:8px;
  z-index:20;
}

.menuItem{ width:100%; justify-content:flex-start; }

.menuSep{
  height:1px;
  background: rgba(255,255,255,.10);
  margin:6px 2px;
  border-radius:999px;
}

/* =========================================================
  10) TASKS (Notebook cards)
========================================================== */
.tasks{
  position:relative;
  margin-top:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  padding:10px 10px 8px;
}
.tasks[data-accent="1"]::before,
.tasks[data-accent="1"]::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:6px;
  background: var(--accentStrip, rgba(255,255,255,.35));
  opacity:.95;
  pointer-events:none;
  border-radius:0 !important;
}
.tasks[data-accent="1"]::before{ left:0; }
.tasks[data-accent="1"]::after{ right:0; }

.tasks[data-accent="1"]{ padding-left:16px; padding-right:16px; }

.tasksHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}

.tasksLabel{
  font-size:10.5px;
  letter-spacing:.28em;
  text-transform:uppercase;
  color: rgba(255,255,255,.62);
  user-select:none;
}
.tasks[data-accent="1"] .tasksLabel{
  color: color-mix(in oklab, var(--accentStrip), rgba(255,255,255,.80) 78%);
}

.tasksAdd{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.78);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
}
.tasksAdd:hover{ background: rgba(255,255,255,.09); }

.taskList{ display:grid; gap:6px; }

.taskRow{
  display:flex;
  align-items:flex-start;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.taskRow:hover{ background: rgba(255,255,255,.055); }

.taskCheck{
  width:18px;
  height:18px;
  margin-top:1px;
  accent-color: var(--accentB);
  cursor:pointer;
  flex:0 0 auto;
}

.taskText{
  flex:1 1 auto;
  font-size:12.5px;
  color: rgba(255,255,255,.78);
  line-height:1.35;
  word-break: break-word;
}
.taskText.done{ opacity:.55; text-decoration: line-through; }

.taskDel{
  width:30px;height:30px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:pointer;
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.taskDel:hover{ background: rgba(255,255,255,.09); }

.taskEmpty{
  font-size:12.5px;
  color: rgba(255,255,255,.55);
  padding:6px 2px 2px;
}

/* =========================================================
  11) 2-COLUMN LAYOUT + NOTEBOOK
========================================================== */
.layout2{
  display:grid;
  grid-template-columns: minmax(360px, 470px) minmax(420px, 1fr);
  gap:14px;
  align-items:start;
}
@media (max-width: 980px){ .layout2{ grid-template-columns: 1fr; } }

.notebook{ position: sticky; top: 18px; }
@media (max-width: 980px){ .notebook{ position: static; } }

/* =========================================================
  12) HERO NAV DOTS (ELEGANT PEARL)
========================================================== */
.heroDots{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  padding: 6px 12px;
  border-radius: 999px;

  background:
    radial-gradient(120% 200% at 50% 0%,
      rgba(255,255,255,.10),
      rgba(255,255,255,.03) 55%,
      rgba(0,0,0,.10) 100%
    ),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));

  border: 1px solid rgba(255,255,255,.12);
  box-shadow:
    0 18px 70px rgba(0,0,0,.38),
    inset 0 1px 0 rgba(255,255,255,.10),
    inset 0 -1px 0 rgba(0,0,0,.35);
  backdrop-filter: blur(12px);
}

.navDot{
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display:inline-block;
  cursor:pointer;
  position:relative;
  isolation:isolate;

  background:
    radial-gradient(circle at 30% 28%,
      rgba(255,255,255,.98) 0%,
      rgba(255,255,255,.84) 24%,
      rgba(255,255,255,.58) 44%,
      rgba(220,225,235,.22) 70%,
      rgba(0,0,0,0) 100%
    ),
    conic-gradient(from 210deg at 50% 55%,
      rgba(255,255,255,0) 0deg,
      rgba(255,79,216,.10) 55deg,
      rgba(109,94,252,.10) 130deg,
      rgba(34,211,238,.08) 205deg,
      rgba(255,255,255,0) 320deg,
      rgba(255,255,255,0) 360deg
    ),
    radial-gradient(circle at 50% 72%,
      rgba(0,0,0,.22),
      rgba(0,0,0,0) 58%
    );

  border: 1px solid rgba(255,255,255,.26);

  box-shadow:
    inset 0 1px 1px rgba(255,255,255,.35),
    inset 0 -1px 2px rgba(0,0,0,.40),
    0 10px 22px rgba(0,0,0,.48),
    0 0 0 2px rgba(255,255,255,.06);

  transition:
    transform .22s var(--ease),
    box-shadow .22s var(--ease),
    border-color .22s var(--ease),
    filter .22s var(--ease);
}

/* Specular highlight */
.navDot::before{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:50%;
  pointer-events:none;
  background: radial-gradient(circle at 28% 24%,
    rgba(255,255,255,.92) 0%,
    rgba(255,255,255,0) 58%
  );
  opacity:.95;
  mix-blend-mode: screen;
}

/* Soft aura (controlled) */
.navDot::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:50%;
  pointer-events:none;
  opacity: .10;
  filter: blur(10px);
  background: radial-gradient(circle,
    rgba(255,255,255,.40),
    rgba(255,255,255,0) 70%
  );
  z-index: -1;
}

.navDot:hover{
  transform: translateY(-1px) scale(1.20);
  border-color: rgba(255,255,255,.34);
  filter: saturate(1.06) brightness(1.06);
  box-shadow:
    inset 0 1px 1px rgba(255,255,255,.40),
    inset 0 -1px 2px rgba(0,0,0,.45),
    0 14px 30px rgba(0,0,0,.52),
    0 0 0 3px rgba(255,255,255,.08);
}

.navDot:focus-visible{
  outline:none;
  box-shadow:
    inset 0 1px 1px rgba(255,255,255,.40),
    inset 0 -1px 2px rgba(0,0,0,.45),
    0 0 0 3px rgba(255,255,255,.14),
    0 0 0 6px rgba(255,255,255,.06),
    0 14px 30px rgba(0,0,0,.52);
}

/* Center-stone highlight (first dot) */
.heroDots .navDot:first-child{
  transform: scale(1.18);
  border-color: rgba(255,255,255,.40);
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.44),
    inset 0 -1px 2px rgba(0,0,0,.48),
    0 16px 36px rgba(0,0,0,.55),
    0 0 0 3px rgba(255,255,255,.10);
}

/* =========================================================
  13) MOTION / PERFORMANCE
========================================================== */
@media (prefers-reduced-motion: reduce){
  body::before{ animation:none !important; }
  .btn, .tile, .iconBtn, .twisty, .dragHandle{ transition:none !important; }
  .heroBanner::after{ animation:none !important; }
}

  :root{
  --font-royal: ui-serif, Georgia, "Times New Roman", serif;
  --font-soft-royal: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;
}




/* subtle aura ring */
.navDot::after{
  opacity: .14 !important;
  filter: blur(10px) !important;
  background: radial-gradient(circle,
    rgba(255,255,255,.55),
    rgba(180,210,255,.16) 38%,
    rgba(255,255,255,0) 70%
  ) !important;
}

/* shimmer sweep layer */
.navDot i,
.navDot em{ display:none; } /* harmless if you don‚Äôt have these */

.navDot::before{
  /* keep your highlight, but make it ‚Äúalive‚Äù */
  animation: pearlBreath 3.6s ease-in-out infinite;
}

/* add a moving glint without changing your HTML */
.navDot{
  position: relative;
}
.navDot span{ display:none; } /* harmless */

/* moving shimmer */
.navDot{
  --pearl-shimmer: linear-gradient(120deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,.55) 35%,
    rgba(210,230,255,.22) 50%,
    rgba(255,255,255,0) 70%
  );
}
.navDot::marker{ content:""; }

.navDot::before{
  /* keep your specular highlight AND add a faint sweep */
  background:
    radial-gradient(circle at 28% 24%,
      rgba(255,255,255,.92) 0%,
      rgba(255,255,255,0) 58%
    ),
    var(--pearl-shimmer);
  background-size: 100% 100%, 180% 100%;
  background-position: 0 0, -120% 0;
  mix-blend-mode: screen;
  animation: pearlBreath 3.6s ease-in-out infinite, pearlSweep 4.8s linear infinite;
}

@keyframes pearlBreath{
  0%,100%{ opacity:.82; transform: scale(1); }
  50%{ opacity:.98; transform: scale(1.03); }
}

@keyframes pearlSweep{
  0%{ background-position: 0 0, -120% 0; }
  100%{ background-position: 0 0, 140% 0; }
}

/* ‚ÄúCurrent‚Äù pearl gets a slightly stronger magic ring */
.heroDots .navDot:first-child{
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.46),
    inset 0 -1px 2px rgba(0,0,0,.52),
    0 16px 36px rgba(0,0,0,.55),
    0 0 0 3px rgba(255,255,255,.12),
    0 0 18px rgba(210,230,255,.12) !important;
}

/* Respect motion settings */
@media (prefers-reduced-motion: reduce){
  .navDot::before{ animation: none !important; }
}
/* =========================================================
   PRINCESS TYPOGRAPHY + MAGICAL PEARLS (FINAL)
========================================================== */

:root{
  --font-princess: "Playfair Display SC", "Playfair Display", ui-serif, Georgia, serif;
  --font-soft: "Cormorant", ui-serif, Georgia, serif;
}





.navDot{
  position: relative;
  overflow: visible;
}

/* pearl body refinement */
.navDot{
  background:
    radial-gradient(circle at 30% 28%,
      rgba(255,255,255,1) 0%,
      rgba(255,255,255,.85) 22%,
      rgba(235,235,245,.55) 42%,
      rgba(200,205,220,.25) 70%,
      transparent 100%
    ) !important;

  border: 1px solid rgba(255,255,255,.28) !important;

  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.45),
    inset 0 -1px 2px rgba(0,0,0,.35),
    0 10px 22px rgba(0,0,0,.45),
    0 0 0 2px rgba(255,255,255,.06) !important;
}

/* subtle magical aura */
.navDot::after{
  content:"";
  position:absolute;
  inset:-8px;
  border-radius:50%;
  pointer-events:none;

  background: radial-gradient(circle,
    rgba(255,255,255,.45),
    rgba(210,225,255,.18) 40%,
    transparent 70%
  );

  filter: blur(10px);
  opacity:.35;
}

/* shimmer breath (VERY soft) */
.navDot::before{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:50%;
  pointer-events:none;

  background:
    radial-gradient(circle at 28% 24%,
      rgba(255,255,255,.95),
      rgba(255,255,255,0) 60%
    );

  opacity:.85;
  animation: pearlGlow 3.8s ease-in-out infinite;
}

@keyframes pearlGlow{
  0%,100%{ opacity:.75; }
  50%{ opacity:.95; }
}

/* active pearl = chosen jewel */
.heroDots .navDot:first-child{
  transform: scale(1.18);
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.55),
    inset 0 -1px 2px rgba(0,0,0,.45),
    0 14px 34px rgba(0,0,0,.55),
    0 0 0 3px rgba(255,255,255,.12),
    0 0 18px rgba(220,230,255,.18) !important;
}

/* respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .navDot::before{ animation:none !important; }
}


:root{
  --font-princess-title: "DM Serif Display", "Yeseva One", ui-serif, Georgia, serif;
  --font-princess-sub: "Fraunces", ui-serif, Georgia, serif;
  --font-princess-script: "Petit Formal Script", ui-serif, Georgia, serif;
}


/* optional cute flourish on the title (toggle on/off) */
.heroTitle::after{
  content:"";
  display:block;
  height:10px;
}


.heroSubtitle::after{
  content:"";
  display:block;
  width: 110px;
  height: 1px;
  margin: 10px auto 0;
  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    rgba(255,255,255,.30),
    rgba(255,190,230,.25),
    rgba(255,255,255,.30),
    rgba(255,255,255,0)
  );
  opacity:.9;
}

/* =========================================================
   PEARLS: MORE "MAGIC" (shimmer + glow) but still classy
========================================================== */

/* tray looks like jewelry */
.heroDots{
  padding: 7px 14px !important;
  gap: 12px !important;
  background:
    radial-gradient(120% 200% at 50% 0%,
      rgba(255,255,255,.14),
      rgba(255,255,255,.04) 55%,
      rgba(0,0,0,.12) 100%
    ),
    linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  box-shadow:
    0 18px 70px rgba(0,0,0,.38),
    inset 0 1px 0 rgba(255,255,255,.12),
    inset 0 -1px 0 rgba(0,0,0,.35) !important;
}

/* pearl base (cabochon) */
.navDot{
  width: 12px !important;
  height: 12px !important;
  border-radius: 50%;
  position: relative;
  isolation: isolate;
  border: 1px solid rgba(255,255,255,.30) !important;

  background:
    radial-gradient(circle at 30% 26%,
      rgba(255,255,255,1) 0%,
      rgba(255,255,255,.84) 24%,
      rgba(245,245,255,.62) 44%,
      rgba(215,220,235,.25) 72%,
      rgba(0,0,0,0) 100%
    ),
    conic-gradient(from 210deg at 50% 60%,
      rgba(255,255,255,0) 0deg,
      rgba(255,190,230,.14) 70deg,
      rgba(210,215,255,.12) 150deg,
      rgba(190,240,255,.10) 230deg,
      rgba(255,255,255,0) 330deg,
      rgba(255,255,255,0) 360deg
    ) !important;

  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.55),
    inset 0 -1px 2px rgba(0,0,0,.46),
    0 10px 22px rgba(0,0,0,.48),
    0 0 0 2px rgba(255,255,255,.06) !important;

  transition: transform .20s var(--ease), filter .20s var(--ease), box-shadow .20s var(--ease);
}

/* sparkle aura */
.navDot::after{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius:50%;
  pointer-events:none;
  background: radial-gradient(circle,
    rgba(255,255,255,.55),
    rgba(255,190,230,.22) 38%,
    rgba(210,215,255,.14) 56%,
    transparent 72%
  );
  filter: blur(10px);
  opacity:.35;
}

/* moving shimmer (magic sweep) */
.navDot::before{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:50%;
  pointer-events:none;

  background:
    radial-gradient(circle at 28% 22%,
      rgba(255,255,255,.95),
      rgba(255,255,255,0) 58%
    ),
    linear-gradient(120deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.55) 35%,
      rgba(255,190,230,.22) 50%,
      rgba(255,255,255,0) 70%
    );

  background-size: 100% 100%, 180% 100%;
  background-position: 0 0, -120% 0;
  mix-blend-mode: screen;

  animation: pearlBreath 3.6s ease-in-out infinite, pearlSweep 4.6s linear infinite;
  opacity:.9;
}

@keyframes pearlBreath{
  0%,100%{ opacity:.70; transform: scale(1); }
  50%{ opacity:1; transform: scale(1.05); }
}

@keyframes pearlSweep{
  0%{ background-position: 0 0, -120% 0; }
  100%{ background-position: 0 0, 140% 0; }
}

/* hover = cute sparkle pop */
.navDot:hover{
  transform: translateY(-1px) scale(1.22) !important;
  filter: brightness(1.08) saturate(1.08);
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.62),
    inset 0 -1px 2px rgba(0,0,0,.52),
    0 14px 30px rgba(0,0,0,.55),
    0 0 0 3px rgba(255,255,255,.10) !important;
}

/* current page dot = main jewel */
.heroDots .navDot:first-child{
  transform: scale(1.18);
  border-color: rgba(255,255,255,.42) !important;
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.68),
    inset 0 -1px 2px rgba(0,0,0,.55),
    0 16px 36px rgba(0,0,0,.58),
    0 0 0 3px rgba(255,255,255,.12),
    0 0 18px rgba(255,190,230,.16) !important;
}

/* accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .navDot::before{ animation:none !important; }
}
/* =========================================================
   HERO TYPE (ONE VERSION ONLY)
   Caramel = title
   Alumni Sans Pinstripe = subtitle
========================================================== */

.heroCenter{
  width: 100%;
  max-width: 920px;              /* give script room */
  margin: 0 auto;
}

.heroTitle{
  font-family: "Caramel", cursive !important;
  font-weight: 400 !important;
  font-style: normal !important;  /* Caramel already has the look */
  text-transform: none !important;

  /* sizing tuned to avoid clipping */
  font-size: clamp(46px, 6vw, 76px) !important;
  line-height: 1.18 !important;   /* KEY: prevents script clipping */
  letter-spacing: .01em !important;

  display: inline-block;          /* prevents weird grid clipping */
  padding: 0 .25em .18em;         /* gives the last letter room */
  overflow: visible !important;

  /* pearly blush gradient */
  background: linear-gradient(180deg,
    rgba(255,255,255,1) 0%,
    rgba(255,240,250,.92) 38%,
    rgba(246,199,221,.92) 68%,
    rgba(255,255,255,.98) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;

  text-shadow:
    0 10px 28px rgba(0,0,0,.48),
    0 0 16px rgba(255,190,225,.18);
}

/* WEBPAGE HUB */
.heroSubtitle{
  font-family: "Alumni Sans Pinstripe", sans-serif !important;
  font-weight: 400 !important;
  text-transform: uppercase !important;
  letter-spacing: .60em !important;
  font-size: 13px !important;
  margin-top: 6px !important;

  color: rgba(255,255,255,.72) !important;
  opacity: .92 !important;
}

/* Give the banner a touch more vertical room for Caramel */
.heroBanner{ min-height: 180px !important; }
.heroInner{ padding-top: 26px !important; padding-bottom: 28px !important; }

/* Make Caramel feel fuller + more ‚Äúcute glam‚Äù */
.heroTitle{
  font-size: clamp(52px, 6.2vw, 84px) !important;
  letter-spacing: .01em !important;
  text-shadow:
    0 10px 28px rgba(0,0,0,.48),
    0 0 18px rgba(255,190,225,.22),
    0 0 34px rgba(210,215,255,.10) !important;
}

/* If you want the subtitle to read clearer */
.heroSubtitle{
  font-size: 14px !important;
  letter-spacing: .58em !important;
  opacity: .95 !important;
}
.navDot::before{
  animation: pearlBreath 3.6s ease-in-out infinite, pearlSweep 5.2s linear infinite !important;
}

@keyframes pearlBreath{
  0%,100%{ opacity:.72; transform: scale(1); }
  50%{ opacity:1; transform: scale(1.06); }
}

@keyframes pearlSweep{
  0%{ background-position: 0 0, -120% 0; }
  100%{ background-position: 0 0, 140% 0; }
}
/* =========================================================
   HERO BANNER ‚Äî SHORTER, TIGHTER, STILL SAFE FOR CARAMEL
========================================================== */

/* Reduce overall banner height */
.heroBanner{
  min-height: 135px !important;   /* down from ~180 */
}

/* Tighten inner padding */
.heroInner{
  padding-top: 18px !important;
  padding-bottom: 20px !important;
}

/* Pull title + subtitle closer together */
.heroTitle{
  margin-bottom: 4px !important;
}

.heroSubtitle{
  margin-top: 2px !important;
}

/* Optional: nudge content slightly upward for balance */
.heroCenter{
  transform: translateY(-2px);
}

/* ================================
   HEADER OVERRIDES (PASTE LAST)
   - makes banner MUCH shorter
   - swaps title font to something more ‚Äúprincessy‚Äù
================================ */

.heroTitle{ font-family:"Annie Use Your Telescope", cursive !important; }



/* Subtitle stays pinstripe */
.heroSubtitle{
  font-family:"Alumni Sans Pinstripe", sans-serif !important;
  text-transform: uppercase !important;
  letter-spacing: .55em !important;
  font-size: 12px !important;
  margin: 0 !important;
}

/* --- MAKE THE BANNER NOT TALL --- */
.heroBanner{
  min-height: 110px !important;     /* big cut */
  padding: 0 !important;
}

.heroInner{
  padding: 12px 18px 14px !important; /* tighter */
  grid-template-rows: auto auto !important;
}

.heroTop{
  margin: 0 0 6px !important;       /* less space above title */
}

.heroCenter{
  margin: 0 auto !important;
  transform: none !important;
}

/* tighten title metrics (prevents ‚Äúfake tall‚Äù look) */
.heroTitle{
  margin: 0 !important;
  line-height: .85 !important;
  letter-spacing: .02em !important;
  text-transform: none !important;

  /* keep your pearly ink */
  background: linear-gradient(180deg,#fff 0%,#ffe6f1 35%,#f6c7dd 65%,#fff 100%) !important;
  -webkit-background-clip:text !important;
  background-clip:text !important;
  color: transparent !important;
}

/* shrink the pearl tray slightly so it doesn‚Äôt force height */
.heroDots{
  padding: 5px 10px !important;
  gap: 10px !important;
}

/* if you added any decorative ‚Äúafter‚Äù spacing earlier, kill it */
.heroTitle::after,
.heroSubtitle::after{
  content: none !important;
}
/* ================================
   DRAMATIC SHIMMER + GLOW (ANNIE)
================================ */

.heroTitle{
  font-family: "Annie Use Your Telescope", cursive !important;
  font-weight: 400 !important;
  letter-spacing: .02em !important;
  line-height: .88 !important;

  /* Make shimmer obvious */
  background-image:
    /* moving bright band */
    linear-gradient(120deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,.95) 18%,
      rgba(255,205,235,.95) 28%,
      rgba(210,230,255,.90) 38%,
      rgba(255,255,255,0) 55%
    ),
    /* base ink */
    linear-gradient(180deg,
      #ffffff 0%,
      #ffe1f0 35%,
      #f3b9d8 70%,
      #ffffff 100%
    );

  background-size: 260% 100%, 100% 100%;
  background-position: -140% 0, 0 0;

  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;

  /* BIG glow (noticeable) */
  text-shadow:
    0 0 8px rgba(255,255,255,.85),
    0 0 18px rgba(255,190,230,.80),
    0 0 38px rgba(210,230,255,.55),
    0 0 70px rgba(255,120,200,.35),
    0 14px 30px rgba(0,0,0,.55);

  /* Extra ‚Äúpop‚Äù glow around the whole text */
  filter:
    drop-shadow(0 0 10px rgba(255,200,235,.55))
    drop-shadow(0 0 22px rgba(210,230,255,.35));

  animation: titleShimmerDRAMATIC 2.4s linear infinite;
}

/* Optional: a tiny outline helps the glow read on dark bg */
.heroTitle{
  -webkit-text-stroke: 0.35px rgba(255,255,255,.18);
}

/* Make the shimmer sweep clearly visible */
@keyframes titleShimmerDRAMATIC{
  0%   { background-position: -140% 0, 0 0; }
  100% { background-position:  140% 0, 0 0; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .heroTitle{ animation:none !important; }
}


</style>

  
  <!-- ==================================================================================================================
    =========================================================END OF STYLE=========================================================
  =================================================================================================================== -->

</head>
  <!-- ==================================================================================================================
    =========================================================START OF BODY=========================================================
  =================================================================================================================== -->
<body>
  <div class="wrap">

    <header class="heroBanner" aria-label="Navigation Hub banner">
      <div class="heroLaser heroLaserTop" aria-hidden="true"></div>

      <div class="heroInner">
        <div class="heroTop">
          <div class="heroDots" aria-label="Hero navigation">
  <a
    href="https://vigilproject.org/2001navigation.html"
    class="navDot"
    aria-label="Navigation Hub"
  ></a>

  <a
    href="https://vigilproject.org/2001knottenav.html"
    class="navDot"
    aria-label="Knotte Navigation"
  ></a>

  <a
    href="#notebook"
    class="navDot"
    aria-label="Task notebook"
  ></a>
</div>

        </div>

        <div class="heroCenter">
          <h1 class="heroTitle">LabContext</h1>
          <p class="heroSubtitle">Webpage Hub</p>
        </div>
      </div>

      <div class="heroLaser heroLaserBottom" aria-hidden="true"></div>
    </header>

    <div class="layout2">

      <!-- LEFT: Navigation -->
      <section class="card" aria-label="Navigation hub">
        <div class="toolbar" id="top">
          <div class="toolbarTitle">Webpage Navigation</div>

          <div class="toolbarCenter">
            <label class="sr-only" for="search">Search</label>
            <input class="input" id="search" type="search" placeholder="Search titles, URLs, notes, tasks‚Ä¶" />
          </div>

          <div class="toolbarRight">
            <button class="btn" id="addItem" type="button">Ôºã Add</button>

            <details class="menu" id="actionsMenu">
              <summary class="btn" aria-label="Actions">‚ò∞ Actions</summary>
              <div class="menuList" role="menu" aria-label="Toolbar actions">
                <button class="btn menuItem" id="expandAll" type="button">‚ñæ Expand all</button>
                <button class="btn menuItem" id="collapseAll" type="button">‚ñ∏ Collapse all</button>
                <div class="menuSep"></div>
                <button class="btn menuItem" id="exportJson" type="button">‚á™ Export JSON</button>
                <button class="btn menuItem" id="resetEdits" type="button">‚Ü∫ Reset edits</button>
              </div>
            </details>
          </div>
        </div>

        <div class="tree" id="treeRoot"></div>
      </section>

      <!-- RIGHT: Notebook -->
      <aside class="card notebook" id="notebook" aria-label="Task notebook">
        <div class="notebookHead">
          <div>
            <div class="kicker">TASK NOTEBOOK</div>
            <div class="notebookTitle" id="nbTitle">Selected task lists</div>
          </div>

          <div class="notebookTabs" role="tablist" aria-label="Notebook views">
            <button class="btn" id="nbTabSelected" type="button" aria-selected="true">Selected</button>
            <button class="btn" id="nbTabAll" type="button" aria-selected="false">All</button>
            <button class="btn" id="nbResetSelected" type="button" title="Clear selected task lists">‚Ü∫ Reset</button>
          </div>
        </div>

        <div class="notebookBody" id="nbBody">
          <div class="taskEmpty">Click üßæ on any page/link to pin its tasks here.</div>
        </div>
      </aside>

    </div>

    <!-- Embedded Data -->
    <script id="navData" type="application/json">
[
  { "type":"group", "id":"core", "title":"Core", "parentId":null, "order":1 },
  { "type":"tile",  "id":"home", "title":"Home", "href":"/index.html", "parentId":"core", "order":1 },

  { "type":"group", "id":"topics", "title":"Topics", "parentId":null, "order":2 },
  { "type":"group", "id":"animals", "title":"Animals", "parentId":"topics", "order":1, "color":"#22d3ee" },
  { "type":"tile",  "id":"animals-index", "title":"Animals", "href":"/animals/index.html", "parentId":"animals", "order":1 },
  { "type":"tile",  "id":"endangered", "title":"Endangered Animals", "href":"/animals/endangered.html", "parentId":"animals", "order":2 },

  { "type":"group", "id":"action", "title":"Take action", "parentId":null, "order":3 },
  { "type":"tile",  "id":"donate-wwf", "title":"Donate: WWF", "href":"https://www.worldwildlife.org/", "parentId":"action", "order":1 }
]
    </script>

    <!-- Add/Edit Modal -->
    <div class="modalBackdrop" id="modalBackdrop" hidden>
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modalHead">
          <div>
            <div class="kicker" id="modalKicker">ADD</div>
            <div id="modalTitle" class="modalTitle">Item</div>
          </div>
          <button class="iconBtn" id="closeModal" type="button" aria-label="Close">‚úï</button>
        </div>

        <div class="modalBody">
          <div class="grid2">
            <label class="field">
              <span>Type</span>
              <select class="input" id="fType">
                <option value="group">Page (group)</option>
                <option value="tile">Link (tile)</option>
              </select>
            </label>

            <label class="field">
              <span>Title</span>
              <input class="input" id="fTitle" placeholder="Title" />
            </label>
          </div>

          <label class="field">
            <span>Hyperlink</span>
            <input class="input" id="fHref" placeholder="https://‚Ä¶ or /path" />
          </label>
<label class="field">
  <span>Intended Link (optional)</span>
  <input class="input" id="fIntendedLink" placeholder="https://‚Ä¶ or /path (can be blank)" />
</label>

          <label class="field">
            <span>WEBPAGE TASKS (one per line)</span>
            <textarea class="input" id="fTasks"
              placeholder="- Draft copy&#10;- Add donate buttons&#10;- Proofread"
              style="min-height:120px; resize:vertical; padding-top:10px;"></textarea>
          </label>

          <label class="field" id="groupColorField">
            <span>Group color</span>
            <input class="input" id="fColor" type="color" value="#6d5efc"
              style="height:44px; padding:6px 10px;" />
          </label>

          <div class="modalActions">
            <button class="btn" id="deleteItem" type="button">üóë Delete</button>
            <div style="flex:1"></div>
            <button class="btn" id="saveItem" type="button">üíæ Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  </div>
</body>
<script>
/* =========================================================
  Vigil ‚Äî Unlimited nesting tree (clean build)
========================================================== */

/* =========================================================
  1) STORAGE KEYS
========================================================== */
const LS_NODES = "vigil_nodes_tree_2001knotte_v1";
const LS_COLLAPSED = "vigil_collapsed_groups_2001knotte_v1";
const LS_TASK_SELECTED = "vigil_task_selected_2001knotte_v1";


/* =========================================================
  2) DOM HELPERS + REFERENCES
========================================================== */
const $ = (sel) => document.querySelector(sel);

const treeRootEl = $("#treeRoot");
const searchEl = $("#search");

const expandAllBtn = $("#expandAll");
const collapseAllBtn = $("#collapseAll");
const addItemBtn = $("#addItem");
const exportBtn = $("#exportJson");
const resetBtn = $("#resetEdits");

const actionsMenu = $("#actionsMenu");

const modalBackdrop = $("#modalBackdrop");
const closeModalBtn = $("#closeModal");
const saveItemBtn = $("#saveItem");
const deleteItemBtn = $("#deleteItem");

const modalKicker = $("#modalKicker");
const modalTitle = $("#modalTitle");

const fType = $("#fType");
const fTitle = $("#fTitle");
const fHref = $("#fHref");
const fTasks = $("#fTasks");
const fColor = $("#fColor");
  const fIntendedLink = $("#fIntendedLink");
const groupColorField = $("#groupColorField");

const nbTitle = $("#nbTitle");
const nbBody = $("#nbBody");
const nbTabSelected = $("#nbTabSelected");
const nbTabAll = $("#nbTabAll");
const nbResetSelected = $("#nbResetSelected");

/* =========================================================
  3) APP STATE
========================================================== */
let filter = "";
let editingId = null;

let notebookMode = "selected"; // "selected" | "all"
let selectedTaskIds = new Set();

let draftParentId = null;
let draftOrder = 9999;

let NODES = [];
let collapsedGroups = new Set();
let _sortables = [];

/* =========================================================
  4) UTILITIES
========================================================== */
const escapeHtml = (s) => (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const slugify = (s) => (s || "")
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/(^-|-$)/g, "");

const closeActionsMenu = () => {
  if (actionsMenu && actionsMenu.open) actionsMenu.open = false;
};

const copyToClipboard = async (text) => {
  try { await navigator.clipboard.writeText(text); } catch {}
};

/* =========================================================
  TASKS HELPERS
========================================================== */
const normalizeTasks = (node) => {
  if (typeof node.tasks === "string") node.tasks = [{ text: node.tasks, done:false }];
  if (!Array.isArray(node.tasks)) node.tasks = [];
};

const tasksToTextarea = (tasks) => {
  if (!Array.isArray(tasks) || !tasks.length) return "";
  return tasks.map(t => `${t?.done ? "[x] " : ""}${t?.text ?? ""}`.trimEnd()).join("\n");
};

const textareaToTasks = (value) => {
  const raw = (value || "").split("\n").map(s => s.trim()).filter(Boolean);
  return raw.map(line => {
    const done = /^\[x\]\s*/i.test(line) || /^-?\s*\[x\]\s*/i.test(line);
    const text = line
      .replace(/^-?\s*\[x\]\s*/i, "")
      .replace(/^\[x\]\s*/i, "")
      .replace(/^-+\s*/i, "")
      .trim();
    return { text, done };
  }).filter(t => t.text);
};

/* =========================================================
  5) LOAD / SAVE
========================================================== */
const loadEmbedded = () => {
  const el = document.getElementById("navData");
  return JSON.parse(el?.textContent || "[]");
};

const loadNodes = () => {
  const raw = localStorage.getItem(LS_NODES);
  if (raw) { try { return JSON.parse(raw); } catch {} }
  return loadEmbedded();
};

const saveNodes = () => localStorage.setItem(LS_NODES, JSON.stringify(NODES, null, 2));

const loadCollapsed = () => {
  const raw = localStorage.getItem(LS_COLLAPSED);
  if (!raw) return new Set();
  try { return new Set(JSON.parse(raw)); } catch { return new Set(); }
};

const saveCollapsed = () =>
  localStorage.setItem(LS_COLLAPSED, JSON.stringify([...collapsedGroups], null, 2));

const loadSelectedTasks = () => {
  const raw = localStorage.getItem(LS_TASK_SELECTED);
  if (!raw) return new Set();
  try { return new Set(JSON.parse(raw)); } catch { return new Set(); }
};

const saveSelectedTasks = () =>
  localStorage.setItem(LS_TASK_SELECTED, JSON.stringify([...selectedTaskIds], null, 2));

/* =========================================================
  6) DATA ACCESSORS
========================================================== */
const nodeById = (id) => NODES.find(n => n.id === id);

const childrenOf = (parentId) =>
  NODES
    .filter(n => (n.parentId ?? null) === (parentId ?? null))
    .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));

const buildDescendantsSet = (groupId) => {
  const out = new Set();
  const stack = [groupId];
  while (stack.length) {
    const cur = stack.pop();
    for (const ch of childrenOf(cur)) {
      out.add(ch.id);
      if (ch.type === "group") stack.push(ch.id);
    }
  }
  return out;
};

const normalizeOrders = () => {
  const parents = new Set(NODES.map(n => n.parentId ?? null));
  for (const p of parents) {
    const kids = childrenOf(p);
    kids.forEach((n, idx) => (n.order = idx + 1));
  }
};

const accentForNode = (id) => {
  let cur = nodeById(id);
  while (cur) {
    if (cur.color) return cur.color;
    if (cur.parentId == null) break;
    cur = nodeById(cur.parentId);
  }
  return "";
};

/* =========================================================
  7) SEARCH / FILTER VISIBILITY
========================================================== */
const matchNode = (n) => {
  if (!filter) return true;
  normalizeTasks(n);
  const taskText = (n.tasks || []).map(t => t.text).join(" ");
const hay = `${n.title||""} ${n.href||""} ${n.intendedLink||""} ${n.notes||""} ${taskText}`.toLowerCase();
  return hay.includes(filter);
};

const visibleSetForFilter = () => {
  if (!filter) return null;

  const visible = new Set();
  const byParent = new Map();

  for (const n of NODES) {
    const p = n.parentId ?? null;
    if (!byParent.has(p)) byParent.set(p, []);
    byParent.get(p).push(n);
  }

  const hasMatchInSubtree = (id) => {
    const n = nodeById(id);
    if (!n) return false;
    if (matchNode(n)) return true;
    if (n.type !== "group") return false;
    const kids = byParent.get(id) || [];
    return kids.some(k => hasMatchInSubtree(k.id));
  };

  const ensureAncestors = (id) => {
    let cur = nodeById(id);
    while (cur) {
      visible.add(cur.id);
      if (cur.parentId == null) break;
      cur = nodeById(cur.parentId);
    }
  };

  for (const n of NODES) {
    if (hasMatchInSubtree(n.id)) ensureAncestors(n.id);
  }

  return visible;
};

/* =========================================================
  8) MODAL: OPEN / CLOSE
========================================================== */
const showModal = () => modalBackdrop.removeAttribute("hidden");
const hideModal = () => modalBackdrop.setAttribute("hidden", "");

const setTypeUI = () => {
  const isGroup = fType.value === "group";
  groupColorField.style.display = isGroup ? "grid" : "none";
};

const openModal = (node, isNew, forceType = null) => {
  showModal();

  editingId = isNew ? null : node.id;
  draftParentId = isNew ? (node.parentId ?? null) : null;
  draftOrder = isNew ? (node.order ?? 9999) : 9999;

  modalKicker.textContent = isNew ? "ADD" : "EDIT";
  modalTitle.textContent = isNew ? "New item" : (node.title || node.id || "Item");

  fType.value = forceType ?? (node.type || "tile");
  setTypeUI();

  fTitle.value = node.title || "";
  fHref.value  = node.href  || "";
  fIntendedLink.value = node.intendedLink || "";
  fColor.value = node.color || "#6d5efc";

  normalizeTasks(node);
  fTasks.value = tasksToTextarea(node.tasks);

  deleteItemBtn.style.display = isNew ? "none" : "inline-flex";
  setTimeout(() => fTitle.focus(), 0);
};

const closeModal = () => {
  hideModal();
  editingId = null;
};

/* =========================================================
  9) CRUD
========================================================== */
const upsert = (updated) => {
  const idx = NODES.findIndex(x => x.id === updated.id);
  if (idx >= 0) NODES[idx] = { ...NODES[idx], ...updated };
  else NODES.push(updated);

  normalizeOrders();
  saveNodes();
  render();
};

const removeNode = (id) => {
  const n = nodeById(id);
  if (!n) return;

  const toDelete = new Set([id]);
  if (n.type === "group") {
    for (const d of buildDescendantsSet(id)) toDelete.add(d);
  }

  for (const x of toDelete) collapsedGroups.delete(x);
  selectedTaskIds.delete(id);

  NODES = NODES.filter(x => !toDelete.has(x.id));
  normalizeOrders();
  saveCollapsed();
  saveSelectedTasks();
  saveNodes();
  render();
};

/* =========================================================
  10) RENDER
========================================================== */
const renderAddButton = (parentId) => {
  const pid = parentId ?? null;
  return `
    <button class="dropHint" type="button"
      onclick="window.__addAt('${escapeHtml(pid ?? "__root__").replaceAll("'","&#039;")}')">
      Ôºã Add here
    </button>
  `;
};

window.__addAt = (parentRaw) => {
  const parentId = (parentRaw === "__root__") ? null : parentRaw;
  openModal({ type:"tile", id:"", title:"", href:"", parentId, notes:"", order:9999, tasks:[] }, true, null);
};

window.__openTasks = (id) => {
  if (selectedTaskIds.has(id)) selectedTaskIds.delete(id);
  else selectedTaskIds.add(id);
  saveSelectedTasks();
  render();
};

window.__taskAdd = (id) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const text = prompt("New task:");
  if (!text || !text.trim()) return;
  n.tasks.push({ text: text.trim(), done:false });
  saveNodes();
  render();
};

window.__taskToggle = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const t = n.tasks[idx];
  if (!t) return;
  t.done = !t.done;
  saveNodes();
  render();
};

window.__taskDelete = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  n.tasks.splice(idx, 1);
  saveNodes();
  render();
};

const renderTile = (n) => {
  const chip = `<span class="chip">Link</span>`;
  const notes = n.notes ? `<div class="notes">${escapeHtml(n.notes)}</div>` : "";
  const href = n.href || "#";
const target = `target="_blank" rel="noreferrer noopener"`;

  return `
    <div class="tile treeItem" data-id="${escapeHtml(n.id)}" data-type="tile">
      <div class="tileMain">
        <a href="${escapeHtml(href)}" ${target} style="text-decoration:none; color:inherit;">
          <div class="tileTitleLine">
            <span class="tileTitle">${escapeHtml(n.title || "(untitled)")}</span>
            ${chip}
          </div>
        </a>
        ${notes}
      </div>

      <div class="actions">
        <button class="iconBtn ${selectedTaskIds.has(n.id) ? "active" : ""}" type="button"
          onclick="window.__openTasks('${escapeHtml(n.id).replaceAll("'","&#039;")}')"
          aria-label="Toggle tasks">üßæ</button>

        <button class="iconBtn" type="button"
          onclick="window.__edit('${escapeHtml(n.id).replaceAll("'","&#039;")}')">‚úé</button>

        <button class="iconBtn" type="button"
          onclick="window.__copy('${escapeHtml(href).replaceAll("'","&#039;")}', '${escapeHtml(n.title||"").replaceAll("'","&#039;")}')">‚ßâ</button>

        <div class="dragHandle" role="button" tabindex="0" aria-label="Drag to move tile" title="Drag to move">‚ãÆ‚ãÆ</div>
      </div>
    </div>
  `;
};

const renderGroup = (g, visibleSet, depth) => {
  const kids = childrenOf(g.id).filter(n => !visibleSet || visibleSet.has(n.id));
  const collapsed = collapsedGroups.has(g.id) && !filter;
  const indentClass = depth > 0 ? "indent" : "";

  const accentAttr = g.color
    ? `data-accent="1" style="--accentStrip:${escapeHtml(g.color)};"`
    : "";

  const body = collapsed ? "" : (
    kids.length
      ? kids.map(n => n.type === "group"
          ? renderGroup(n, visibleSet, depth + 1)
          : renderTile(n)
        ).join("")
      : `${renderAddButton(g.id)}`
  );

  const headerTitle = (() => {
    const title = escapeHtml(g.title || "(group)");
    const href = g.href;
    if (!href) return `<div class="nodeTitle">${title}</div>`;
const target = `target="_blank" rel="noreferrer noopener"`;
    return `<a class="nodeTitle" href="${escapeHtml(href)}" ${target} style="text-decoration:none; color:inherit;">${title}</a>`;
  })();

  return `
    <div class="node treeItem ${indentClass}" data-id="${escapeHtml(g.id)}" data-type="group" ${accentAttr}>
      <div class="nodeHeader">
        <div class="nodeHeaderLeft">
          <button class="twisty" type="button" aria-label="Toggle group"
            onclick="window.__toggle('${escapeHtml(g.id).replaceAll("'","&#039;")}')">
            ${collapsed ? "‚ñ∏" : "‚ñæ"}
          </button>

          <div style="min-width:0">
            ${headerTitle}
            ${g.notes ? `<div class="notes" style="margin-top:2px">${escapeHtml(g.notes)}</div>` : ``}
          </div>
        </div>

        <div class="actions">
          <button class="iconBtn ${selectedTaskIds.has(g.id) ? "active" : ""}" type="button"
            onclick="window.__openTasks('${escapeHtml(g.id).replaceAll("'","&#039;")}')"
            aria-label="Toggle tasks">üßæ</button>

          <button class="iconBtn" type="button"
            onclick="window.__edit('${escapeHtml(g.id).replaceAll("'","&#039;")}')">‚úé</button>

          <button class="iconBtn" type="button"
            onclick="window.__copy('${escapeHtml(g.href||"").replaceAll("'","&#039;")}', '${escapeHtml(g.title||"").replaceAll("'","&#039;")}')">‚ßâ</button>

          <div class="dragHandle" role="button" tabindex="0" aria-label="Drag to move group" title="Drag to move">‚ãÆ‚ãÆ</div>
        </div>
      </div>

      <div class="nodeBody" ${collapsed ? "hidden" : ""} data-container="children" data-parent-id="${escapeHtml(g.id)}">
        ${body}
        ${(!collapsed && kids.length) ? `${renderAddButton(g.id)}` : ``}
      </div>
    </div>
  `;
};

const renderRoot = () => {
  const visibleSet = visibleSetForFilter();
  const roots = childrenOf(null).filter(n => !visibleSet || visibleSet.has(n.id));

  if (!roots.length) {
    treeRootEl.innerHTML = `
      <div class="dropHint">No matches. Try a different search.</div>
      ${renderAddButton(null)}
    `;
    return;
  }

  treeRootEl.innerHTML = `
    <div data-container="children" data-parent-id="__root__">
      ${roots.map(n => n.type === "group" ? renderGroup(n, visibleSet, 0) : renderTile(n)).join("")}
    </div>
  `;
};

/* =========================================================
  NOTEBOOK RENDER
========================================================== */
const renderNotebookSelected = () => {
  const ids = [...selectedTaskIds].filter(id => nodeById(id));

  if (!ids.length) {
    nbTitle.textContent = "Selected task lists";
    nbBody.innerHTML = `<div class="taskEmpty">Toggle üßæ on any page/link to show its tasks here.</div>`;
    return;
  }

  nbTitle.textContent = `Selected task lists (${ids.length})`;

  nbBody.innerHTML = ids.map((id) => {
    const n = nodeById(id);
    normalizeTasks(n);

    const accent = accentForNode(n.id);
    const accentAttr = accent ? `data-accent="1" style="--accentStrip:${escapeHtml(accent)};"` : "";

    const tasks = n.tasks || [];
    const rows = tasks.length
      ? `<div class="taskList">${
          tasks.map((t, idx) => `
            <div class="taskRow">
              <input class="taskCheck" type="checkbox"
                ${t.done ? "checked" : ""}
                onclick="window.__taskToggle('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
                aria-label="Mark task done" />
              <div class="taskText ${t.done ? "done" : ""}">${escapeHtml(t.text)}</div>
              <button class="taskDel" type="button"
                onclick="window.__taskDelete('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
                aria-label="Delete task">‚úï</button>
            </div>
          `).join("")
        }</div>`
      : `<div class="taskEmpty">No tasks yet.</div>`;

    return `
      <div class="tasks" ${accentAttr} aria-label="Webpage tasks">
        <div class="tasksHead">
          <div class="tasksLabel">${escapeHtml(n.title || n.id)}</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="tasksAdd" type="button"
              onclick="window.__taskAdd('${escapeHtml(n.id).replaceAll("'","&#039;")}')">Ôºã Add task</button>
            <button class="tasksAdd" type="button"
              onclick="window.__openTasks('${escapeHtml(n.id).replaceAll("'","&#039;")}')">‚úï Hide</button>
          </div>
        </div>
        ${rows}
      </div>
    `;
  }).join("");
};

const renderNotebookAll = () => {
  const nodesWithTasks = NODES
    .map(n => (normalizeTasks(n), n))
    .filter(n => Array.isArray(n.tasks) && n.tasks.length);

  nbTitle.textContent = "All tasks (across site)";

  if (!nodesWithTasks.length) {
    nbBody.innerHTML = `<div class="taskEmpty">No tasks found yet.</div>`;
    return;
  }

  nbBody.innerHTML = nodesWithTasks.map(n => `
    <div class="tasks" aria-label="Webpage tasks">
      <div class="tasksHead">
        <div class="tasksLabel">${escapeHtml(n.title || n.id)}</div>
        <button class="tasksAdd" type="button"
          onclick="window.__taskAdd('${escapeHtml(n.id).replaceAll("'","&#039;")}')">Ôºã Add task</button>
      </div>
      <div class="taskList">
        ${n.tasks.map((t, idx) => `
          <div class="taskRow">
            <input class="taskCheck" type="checkbox"
              ${t.done ? "checked" : ""}
              onclick="window.__taskToggle('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Mark task done" />
            <div class="taskText ${t.done ? "done" : ""}">${escapeHtml(t.text)}</div>
            <button class="taskDel" type="button"
              onclick="window.__taskDelete('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Delete task">‚úï</button>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
};

const renderNotebook = () => {
  nbTabSelected.setAttribute("aria-selected", notebookMode === "selected");
  nbTabAll.setAttribute("aria-selected", notebookMode === "all");
  if (notebookMode === "selected") renderNotebookSelected();
  else renderNotebookAll();
};

/* =========================================================
  SORTABLE
========================================================== */
const destroySortables = () => {
  _sortables.forEach(s => { try { s.destroy(); } catch {} });
  _sortables = [];
};

const rebuildFromDOM = () => {
  document.querySelectorAll('[data-container="children"]').forEach((containerEl) => {
    const p = containerEl.dataset.parentId;
    const parentId = (p === "__root__") ? null : p;

    const items = [...containerEl.children].filter(el => el.classList.contains("treeItem"));
    items.forEach((el, idx) => {
      const id = el.dataset.id;
      const n = nodeById(id);
      if (!n) return;
      n.parentId = parentId;
      n.order = idx + 1;
    });
  });

  normalizeOrders();
  saveNodes();
};

const isDescendant = (maybeChildId, maybeAncestorId) =>
  buildDescendantsSet(maybeAncestorId).has(maybeChildId);

const initSortables = () => {
  destroySortables();

  document.querySelectorAll('[data-container="children"]').forEach((containerEl) => {
    const s = new Sortable(containerEl, {
      group: "vigil-tree",
      animation: 150,
      draggable: ".treeItem",
      handle: ".dragHandle",
      filter: "a, button",
      preventOnFilter: true,
      fallbackOnBody: true,

      onMove: (evt) => {
        const draggedId = evt.dragged?.dataset?.id;
        const draggedType = evt.dragged?.dataset?.type;

        const toParentRaw = evt.to?.dataset?.parentId;
        const toParentId = (toParentRaw === "__root__") ? null : toParentRaw;

        if (!draggedId) return true;
        if (toParentId === draggedId) return false; // into itself

        if (draggedType === "group" && toParentId) {
          if (isDescendant(toParentId, draggedId)) return false; // into own descendant
        }
        return true;
      },

      onEnd: () => {
        rebuildFromDOM();
        render();
      }
    });

    _sortables.push(s);
  });
};

/* =========================================================
  RENDER PIPELINE
========================================================== */
const render = () => {
  renderRoot();
  initSortables();
  renderNotebook();
};

/* =========================================================
  PUBLIC HOOKS
========================================================== */
window.__toggle = (groupId) => {
  if (collapsedGroups.has(groupId)) collapsedGroups.delete(groupId);
  else collapsedGroups.add(groupId);
  saveCollapsed();
  render();
};

window.__copy = (href, title) => {
  if (!href) return;
  const html = `<a href="${href}" target="_blank" rel="noopener noreferrer">${title || href}</a>`;
  copyToClipboard(html);
};

window.__edit = (id) => {
  const n = nodeById(id);
  if (!n) return;
  openModal(n, false);
};

/* =========================================================
  UI ACTIONS
========================================================== */
const setAllCollapsed = (collapsed) => {
  const allGroups = NODES.filter(n => n.type === "group").map(n => n.id);
  collapsedGroups = new Set(collapsed ? allGroups : []);
  saveCollapsed();
  render();
};

/* =========================================================
  EVENTS
========================================================== */
nbTabSelected.addEventListener("click", () => { notebookMode = "selected"; render(); });
nbTabAll.addEventListener("click", () => { notebookMode = "all"; render(); });

nbResetSelected.addEventListener("click", () => {
  selectedTaskIds.clear();
  saveSelectedTasks();
  render();
});

searchEl.addEventListener("input", (e) => {
  filter = (e.target.value || "").trim().toLowerCase();
  render();
});

expandAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(false); });
collapseAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(true); });

exportBtn.addEventListener("click", async () => {
  closeActionsMenu();
  const json = JSON.stringify(NODES, null, 2);
  try {
    await navigator.clipboard.writeText(json);
    alert("Copied tree JSON to clipboard.");
  } catch {
    console.log(json);
    alert("Could not copy automatically. Check console for JSON.");
  }
});

resetBtn.addEventListener("click", () => {
  closeActionsMenu();
  if (!confirm("Clear saved edits on this device?")) return;
  localStorage.removeItem(LS_NODES);
  localStorage.removeItem(LS_COLLAPSED);
  localStorage.removeItem(LS_TASK_SELECTED);
  location.reload();
});

document.addEventListener("click", (e) => {
  if (actionsMenu?.open && !actionsMenu.contains(e.target)) actionsMenu.open = false;
});

// Global add
addItemBtn.addEventListener("click", () => {
  openModal({ type:"tile", id:"", title:"", href:"", parentId:null, notes:"", order:9999, tasks:[] }, true, null);
});

// Modal close
closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !modalBackdrop.hasAttribute("hidden")) closeModal();
});

fType.addEventListener("change", setTypeUI);

// Save modal
saveItemBtn.addEventListener("click", () => {
  const type  = (fType.value || "tile").trim();
  const title = (fTitle.value || "").trim();
  const href  = (fHref.value || "").trim();
  const intendedLink = (fIntendedLink?.value || "").trim();

  const color = (fColor?.value || "").trim();

  if (!title) return alert("Title is required.");
  if (!href)  return alert("Hyperlink is required.");

  let id = editingId ? editingId : (slugify(title) || "item");

  if (!editingId) {
    const base = id;
    let n = 2;
    while (NODES.some(x => x.id === id)) id = `${base}-${n++}`;
  }

  const existing = nodeById(id);

  const updated = {
    id,
    type,
    title,
    href,
    parentId: existing?.parentId ?? draftParentId ?? null,
    order: existing?.order ?? draftOrder ?? 9999,
    tasks: textareaToTasks(fTasks.value),
  };
if (intendedLink) updated.intendedLink = intendedLink;
else delete updated.intendedLink;

  if (type === "group") updated.color = color || "#6d5efc";
  else delete updated.color;

  upsert(updated);
  closeModal();
});

// Delete modal
deleteItemBtn.addEventListener("click", () => {
  if (!editingId) return;
  if (!confirm("Delete this item? (Groups delete their entire subtree)")) return;
  removeNode(editingId);
  closeModal();
});

/* =========================================================
  BOOT
========================================================== */
NODES = loadNodes();
collapsedGroups = loadCollapsed();
selectedTaskIds = loadSelectedTasks();

NODES.forEach(normalizeTasks);
normalizeOrders();
saveNodes();
setTypeUI();
render();
</script>

</body>
 <!-- ==================================================================================================================
    =========================================================END OF BODY=========================================================
  =================================================================================================================== -->
</html>
