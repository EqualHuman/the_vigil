<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Navigation Hub</title>
  <meta name="color-scheme" content="dark light" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

<!-- ==================================================================================================================
=========================================================START OF STYLE=========================================================
```

=================================================================================================================== -->

<style>
  /* =========================================================
    0) RESET / ACCESSIBILITY
  ========================================================== */
  [hidden]{display:none!important;}
  *{box-sizing:border-box;}
  .sr-only{
    position:absolute;width:1px;height:1px;
    padding:0;margin:-1px;overflow:hidden;
    clip:rect(0,0,0,0);border:0;
  }

  /* =========================================================
    1) THEME TOKENS (CSS VARIABLES)
  ========================================================== */
  :root{
    /* Base */
    --bg0:#050510;
    --bg1:#070a1c;

    /* Surfaces */
    --panel: rgba(255,255,255,.07);
    --panel-2: rgba(255,255,255,.045);
    --border: rgba(255,255,255,.14);

    /* Text */
    --text: rgba(255,255,255,.93);
    --muted: rgba(255,255,255,.68);
    --muted2: rgba(255,255,255,.55);

    /* Accents */
    --accentA:#6d5efc;
    --accentB:#22d3ee;
    --accentC:#ff4fd8;

    /* UI */
    --shadow: 0 18px 70px rgba(0,0,0,.55);
    --ring: 0 0 0 3px rgba(34,211,238,.22);
    --radius: 20px;
    --ease: cubic-bezier(.2,.8,.2,1);

    /* Fonts */
    --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    --serif: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;

    /* Hero glass inks */
    --ornA: rgba(34,211,238,.55);
    --ornB: rgba(109,94,252,.55);
    --ink:  rgba(6,7,20,.88);
    --ink2: rgba(10,12,28,.72);
  }

  /* =========================================================
    2) PAGE / LAYOUT
  ========================================================== */
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);
    min-height:100vh;
    overflow-x:hidden;
    position:relative;

    background:
      radial-gradient(900px 520px at 15% 10%, color-mix(in oklab, var(--accentB), transparent 78%), transparent 65%),
      radial-gradient(900px 520px at 90% 20%, color-mix(in oklab, var(--accentA), transparent 80%), transparent 60%),
      radial-gradient(1100px 650px at 50% 110%, color-mix(in oklab, var(--accentC), transparent 82%), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
  }

  body::before{
    content:"";
    position:fixed;
    inset:-40px;
    pointer-events:none;
    z-index:-1;
    background:
      radial-gradient(closest-side at 25% 25%, rgba(34,211,238,.18), transparent 60%),
      radial-gradient(closest-side at 75% 35%, rgba(109,94,252,.16), transparent 62%),
      radial-gradient(closest-side at 55% 75%, rgba(255,79,216,.14), transparent 60%);
    filter: blur(22px);
    opacity:.9;
    animation: drift 14s var(--ease) infinite alternate;
  }

  @keyframes drift{
    from{ transform: translate3d(-10px,-10px,0) scale(1.02); }
    to  { transform: translate3d(14px,10px,0)  scale(1.05); }
  }

  .wrap{
    max-width:1080px;
    margin:0 auto;
    padding:28px 18px 60px;
  }

  /* =========================================================
    3) HERO BANNER
  ========================================================== */
  .heroBanner{
    position:relative;
    margin:14px 0 18px;
    border-radius: calc(var(--radius) + 14px);
    overflow:hidden;
    isolation:isolate;
    min-height:132px;

    background:
      radial-gradient(900px 260px at 50% 0%, rgba(255,255,255,.09), transparent 62%),
      radial-gradient(900px 380px at 15% 40%, rgba(34,211,238,.12), transparent 62%),
      radial-gradient(900px 380px at 85% 40%, rgba(109,94,252,.12), transparent 62%),
      linear-gradient(180deg, var(--ink), var(--ink2));

    border: 1px solid rgba(255,255,255,.10);
    box-shadow:
      0 22px 90px rgba(0,0,0,.55),
      inset 0 0 0 1px rgba(255,255,255,.06),
      inset 0 0 60px rgba(109,94,252,.08),
      inset 0 0 120px rgba(34,211,238,.06);
  }

  .heroBanner::before{
    content:"";
    position:absolute;
    inset:0;
    padding:1px;
    border-radius: inherit;
    pointer-events:none;
    opacity:.95;
    background: linear-gradient(135deg,
      rgba(34,211,238,.0),
      rgba(34,211,238,.22),
      rgba(109,94,252,.18),
      rgba(255,79,216,.10),
      rgba(34,211,238,.0)
    );
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }

  .heroBanner::after{
    content:"";
    position:absolute;
    inset:0;
    border-radius:inherit;
    pointer-events:none;
    background:
      linear-gradient(120deg, transparent 35%, rgba(255,255,255,.10), transparent 65%),
      radial-gradient(140% 90% at 50% 0%, rgba(255,255,255,.08), transparent 55%),
      linear-gradient(90deg, rgba(0,0,0,.28), transparent 26%, transparent 74%, rgba(0,0,0,.28));
    background-size: 240% 100%, 100% 100%, 100% 100%;
    background-position: -40% 0, 0 0, 0 0;
    mix-blend-mode: overlay;
    opacity:.55;
    animation: bannerShine 12s ease-in-out infinite;
  }

  @keyframes bannerShine{
    0%, 60% { background-position: -40% 0, 0 0, 0 0; }
    100%    { background-position:  40% 0, 0 0, 0 0; }
  }

  /* Disable old hero layers if leftover markup exists */
  .heroStars, .heroAurora, .heroNoise, .heroBg{ display:none; }
  .heroBrandRow{ display:none; }

  .heroInner{
    position:relative;
    z-index:1;
    padding:20px 22px 18px;
    text-align:center;
  }

  .heroTop{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }

  .kickerPill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.22);
    font-size:11px;
    letter-spacing:.26em;
    text-transform:uppercase;
    color: rgba(255,255,255,.70);
  }

  .kDot{
    width:10px;height:10px;border-radius:999px;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.92), rgba(255,255,255,0) 45%),
      color-mix(in oklab, var(--accentB), transparent 20%);
    box-shadow: 0 0 0 2px rgba(34,211,238,.14), 0 0 18px rgba(34,211,238,.18);
  }

  .heroBadges{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
  }

  .badgePill{
    font-size:12px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color: rgba(255,255,255,.75);
  }

  .heroCenter{ max-width:820px; margin:0 auto; }

  .heroTitle{
    margin:0 0 6px;
    font-family: var(--serif);
    font-weight:650;
    font-size: clamp(38px, 5vw, 58px);
    line-height:.98;
    letter-spacing:.04em;
    text-transform:uppercase;
    color: rgba(255,255,255,.92);
    text-shadow: 0 22px 90px rgba(0,0,0,.65);
  }

  .heroSubtitle{
    margin:0;
    font-size:12px;
    letter-spacing:.28em;
    text-transform:uppercase;
    color: rgba(255,255,255,.62);
    opacity:.9;
  }

  .heroDivider{
    position:relative;
    margin:14px auto 0;
    height:2px;
    width:min(520px, 85vw);
    border-radius:999px;
    overflow:hidden;
    opacity:.9;
    background: linear-gradient(90deg,
      rgba(255,255,255,0),
      color-mix(in oklab, var(--accentB), rgba(255,255,255,.65) 45%),
      color-mix(in oklab, var(--accentA), rgba(255,255,255,.65) 45%),
      color-mix(in oklab, var(--accentC), rgba(255,255,255,.60) 40%),
      rgba(255,255,255,0)
    );
  }

  .heroDivider::before{
    content:"";
    position:absolute;
    inset:0;
    height:1px;
    top:50%;
    transform: translateY(-50%);
    background: linear-gradient(90deg,
      transparent,
      rgba(34,211,238,.35),
      rgba(109,94,252,.30),
      rgba(255,79,216,.18),
      transparent
    );
  }

  .heroDivider::after{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(110deg, transparent 20%, rgba(255,255,255,.55), transparent 60%),
      radial-gradient(30px 14px at 50% 50%, rgba(34,211,238,.14), transparent 70%),
      radial-gradient(30px 14px at 50% 50%, rgba(109,94,252,.12), transparent 70%),
      radial-gradient(10px 10px at 50% 50%, rgba(255,255,255,.20), transparent 70%);
    background-size: 220% 100%, 100% 100%, 100% 100%, 100% 100%;
    background-position: -120% 0, 0 0, 0 0, 0 0;
    opacity:.28;
    mix-blend-mode: screen;
    animation: dividerShine 6s ease-in-out infinite;
  }

  @keyframes dividerShine{
    0%, 70% { background-position: -120% 0, 0 0, 0 0, 0 0; }
    100%    { background-position:  120% 0, 0 0, 0 0, 0 0; }
  }

  /* =========================================================
    4) CARD + TOOLBAR
  ========================================================== */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.14);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:visible;
    backdrop-filter: blur(14px);
  }

  .toolbar{
    display:flex;
    gap:14px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    padding:8px 12px;
    background:
      radial-gradient(900px 220px at 15% 0%, rgba(34,211,238,.12), transparent 60%),
      radial-gradient(900px 220px at 85% 0%, rgba(109,94,252,.12), transparent 60%),
      rgba(255,255,255,.03);
    border-bottom:1px solid rgba(255,255,255,.10);
  }

  .leftTools{
    background: rgba(0,0,0,.16);
    border:1px solid rgba(255,255,255,.10);
    padding:6px;
    border-radius:999px;
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  .rightTools,
  .toolbarRight{
    display:flex;
    align-items:center;
    gap:10px;
    margin-left:auto;
    justify-content:flex-end;
    flex-wrap:wrap;
    flex:1;
  }

  /* Toolbar section title */
  .toolbarTitle{
    font-size:11px;
    letter-spacing:.28em;
    text-transform:uppercase;
    color: rgba(255,255,255,.75);
    white-space: nowrap;
    opacity:.6;
    font-weight:500;
    padding-left:6px;
    padding-right:14px;
    border-right: 1px solid rgba(255,255,255,.12);
  }

  /* Force Actions dropdown to sit inline with Add button */
  .toolbarRight details{
    display:inline-flex;
    align-items:center;
  }

  /* =========================================================
    5) BUTTONS + INPUTS
  ========================================================== */
  .btn{
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    color: rgba(255,255,255,.86);
    padding:7px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:12px;
    letter-spacing:.04em;

    display:inline-flex;
    align-items:center;
    gap:8px;
    user-select:none;

    box-shadow:
      0 14px 40px rgba(0,0,0,.30),
      inset 0 1px 0 rgba(255,255,255,.08);

    transition:
      transform .12s var(--ease),
      background .2s var(--ease),
      box-shadow .2s var(--ease),
      border-color .2s var(--ease);
  }

  .btn:hover{
    transform: translateY(-1px);
    border-color: rgba(34,211,238,.26);
    box-shadow:
      0 18px 55px rgba(0,0,0,.35),
      0 0 0 3px rgba(34,211,238,.10);
  }
  .btn:active{ transform: translateY(0) scale(.99); }

  .btnPrimary{
    border-color: rgba(34,211,238,.28);
    background: linear-gradient(180deg, rgba(34,211,238,.18), rgba(109,94,252,.10));
    box-shadow: 0 18px 60px rgba(0,0,0,.35), 0 0 0 3px rgba(34,211,238,.10);
  }
  .btnPrimary:hover{
    border-color: rgba(34,211,238,.40);
    box-shadow: 0 22px 70px rgba(0,0,0,.42), 0 0 0 3px rgba(34,211,238,.14);
  }

  .input{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    color:var(--text);
    padding:8px 10px;
    border-radius:12px;
    font-size:13px;
    min-width:260px;
    max-width:520px;

    /* original default was stretchy; your later override made it fixed */
    flex: 0 0 auto;

    transition: box-shadow .2s var(--ease), border-color .2s var(--ease);
  }

  .input:focus{
    outline:none;
    border-color: color-mix(in oklab, var(--accentB), rgba(255,255,255,.16) 40%);
    box-shadow: 0 0 0 3px rgba(34,211,238,.18);
  }

  select.input{ appearance:none; }

  /* =========================================================
    6) TREE / NODES / TILES
  ========================================================== */
  .tree{
    padding:12px;
    display:grid;
    gap:16px;
  }

  .dropHint{
    padding:10px 12px;
    border-radius:14px;
    border:1px dashed rgba(255,255,255,.22);
    background: rgba(255,255,255,.03);
    color: rgba(255,255,255,.65);
    font-size:12.5px;
    cursor:pointer;
    text-align:left;
  }
  .dropHint:hover{
    background: rgba(255,255,255,.05);
    border-color: rgba(255,255,255,.30);
  }
  .dropHint:focus-visible{
    outline:none;
    box-shadow: var(--ring);
  }

  .node{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .nodeHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 14px;
    user-select:none;
    border-bottom:1px solid rgba(255,255,255,.10);
  }

  .nodeHeaderLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  /* nested nodes spacing */
  .nodeBody > .node{ margin-top:6px; }

  .twisty{
    width:28px;height:28px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:grid;
    place-items:center;
    cursor:pointer;
    flex:0 0 auto;
  }
  .twisty:hover{ background: rgba(255,255,255,.10); }

  .nodeTitle{
    font-weight:750;
    letter-spacing:-.01em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:62ch;
  }

  .nodeBody{
    padding:12px;
    display:grid;
    gap:14px;
  }

  .tile{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    cursor:default;
    transition:
      transform .14s var(--ease),
      background .2s var(--ease),
      border-color .2s var(--ease);
  }
  .tile:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.18);
    background: rgba(255,255,255,.07);
  }

  .tileMain{ flex:1 1 auto; min-width:0; }

  .tileTitleLine{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:4px;
  }

  .tileTitle{ font-weight:650; letter-spacing:-.01em; }

  .chip{
    font-size:11.5px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    color:var(--muted);
  }

  .url{
    font-family:var(--mono);
    font-size:12.5px;
    color:var(--muted);
    word-break: break-all;
    line-height:1.35;
  }

  .notes{
    margin-top:6px;
    font-size:12.5px;
    color:var(--muted2);
    line-height:1.45;
  }

  .actions{
    display:flex;
    gap:8px;
    flex:0 0 auto;
    margin-left:auto;
    align-items:flex-start;
  }

  .iconBtn{
    width:36px;height:36px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    cursor:pointer;
    display:grid;
    place-items:center;
    transition:
      transform .12s var(--ease),
      background .2s var(--ease),
      box-shadow .2s var(--ease);
  }
  .iconBtn:hover{
    background: rgba(255,255,255,.10);
    box-shadow: 0 0 0 3px rgba(109,94,252,.12);
  }
  .iconBtn:active{ transform: translateY(1px); }
  .iconBtn:focus-visible{ outline:none; box-shadow: var(--ring); }

  .indent{
    margin-left:14px;
    border-left:1px solid rgba(255,255,255,.10);
    padding-left:12px;
  }

  /* spacing between sibling groups (root + nested) */
  [data-container="children"]{
    display:grid;
    gap:14px;
  }
  .tree > [data-container="children"]{ gap:18px; }

  /* Drag handle (handle-only dragging) */
  .dragHandle{
    width:36px;height:36px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    display:grid;
    place-items:center;
    cursor:grab;
    user-select:none;
    font-family: var(--mono);
    font-size:16px;
    line-height:1;
    opacity:.9;
    transition:
      transform .12s var(--ease),
      background .2s var(--ease),
      box-shadow .2s var(--ease);
  }
  .dragHandle:hover{
    background: rgba(255,255,255,.10);
    box-shadow: 0 0 0 3px rgba(34,211,238,.12);
  }
  .dragHandle:active{ cursor:grabbing; transform: translateY(1px); }

  /* =========================================================
    7) MODAL
  ========================================================== */
  .modalBackdrop{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.55);
    display:grid;
    place-items:center;
    padding:18px;
    z-index:50;
  }

  .modal{
    width:min(860px, 96vw);
    border-radius:22px;
    border:1px solid rgba(255,255,255,.14);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    box-shadow:0 30px 120px rgba(0,0,0,.65);
    backdrop-filter: blur(14px);
    overflow:hidden;
  }

  .modalHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(255,255,255,.10);
  }

  .kicker{
    font-size:11px;
    letter-spacing:.22em;
    text-transform:uppercase;
    color: color-mix(in oklab, var(--muted), transparent 12%);
    opacity:.95;
  }

  .modalTitle{ font-weight:700; letter-spacing:-.02em; }
  .modalBody{ padding:14px; display:grid; gap:12px; }

  .field{ display:grid; gap:6px; }
  .field > span{ font-size:12px; color:var(--muted2); }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:720px){ .grid2{ grid-template-columns: 1fr; } }

  .modalActions{
    display:flex;
    align-items:center;
    gap:10px;
    padding-top:6px;
  }

  /* =========================================================
    8) DROPDOWN MENU
  ========================================================== */
  .menu{ position:relative; }
  .menu > summary{ list-style:none; }
  .menu > summary::-webkit-details-marker{ display:none; }

  .menuList{
    position:absolute;
    top: calc(100% + 10px);
    right: 0;
    min-width: 190px;
    padding:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,12,28,.85);
    backdrop-filter: blur(14px);
    box-shadow: 0 22px 80px rgba(0,0,0,.55);
    display:grid;
    gap:8px;
    z-index:20;
  }

  .menuItem{ width:100%; justify-content:flex-start; }

  .menu[open] > summary{
    border-color: rgba(34,211,238,.26);
    box-shadow: 0 18px 55px rgba(0,0,0,.35), 0 0 0 3px rgba(34,211,238,.10);
  }

  .menuSep{
    height:1px;
    background: rgba(255,255,255,.10);
    margin:6px 2px;
    border-radius:999px;
  }

  /* =========================================================
    9) OPTIONAL META STRIP
  ========================================================== */
  .meta{
    padding:10px 14px 12px;
    color:var(--muted2);
    font-size:12.5px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }

  #metaLeft{
    font-variant-numeric: tabular-nums;
    letter-spacing:.01em;
    white-space:nowrap;
    padding:6px 10px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    border-radius:999px;
  }

  /* =========================================================
    10) MOTION / PERFORMANCE TOGGLES
  ========================================================== */
  /* Your ‚Äústop pulsing / flicker‚Äù overrides */
  body::before{ animation:none !important; }

  .heroBanner::after{
    animation:none !important;
    opacity:.25 !important;
  }

  .heroDivider::after{
    animation:none !important;
    opacity:.18 !important;
  }

  .heroBanner::after,
  .heroDivider::after{
    mix-blend-mode: normal !important;
  }

  /* optional: reduce heavy blur/backdrop shimmer on some GPUs */
  .heroBanner,
  .card,
  .modal,
  .menuList{
    backdrop-filter: blur(10px);
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce){
    body::before{ animation:none !important; }
    .btn, .tile, .iconBtn, .twisty, .dragHandle{ transition:none !important; }
    .heroBanner::after, .heroDivider::after{ animation:none !important; }
  }

/* =========================================================
  WEBPAGE TASKS (per tile & group)
========================================================== */
.tasks{
  margin-top:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  padding:10px 10px 8px;
}

.tasksHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}

.tasksLabel{
  font-size:10.5px;
  letter-spacing:.28em;
  text-transform:uppercase;
  color: rgba(255,255,255,.62);
  user-select:none;
}

.tasksAdd{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.78);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
}
.tasksAdd:hover{ background: rgba(255,255,255,.09); }

.taskList{
  display:grid;
  gap:6px;
}

.taskRow{
  display:flex;
  align-items:flex-start;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}

.taskRow:hover{ background: rgba(255,255,255,.055); }

.taskCheck{
  width:18px;
  height:18px;
  margin-top:1px;
  accent-color: var(--accentB);
  cursor:pointer;
  flex:0 0 auto;
}

.taskText{
  flex:1 1 auto;
  font-size:12.5px;
  color: rgba(255,255,255,.78);
  line-height:1.35;
  word-break: break-word;
}
.taskText.done{
  opacity:.55;
  text-decoration: line-through;
}

.taskDel{
  width:30px;height:30px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:pointer;
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.taskDel:hover{ background: rgba(255,255,255,.09); }

.taskEmpty{
  font-size:12.5px;
  color: rgba(255,255,255,.55);
  padding:6px 2px 2px;
}

  /* ===== 2-column layout ===== */
.layout2{
  display:grid;
  grid-template-columns: 1.35fr .85fr;
  gap:16px;
  align-items:start;
}

@media (max-width: 980px){
  .layout2{ grid-template-columns: 1fr; }
}

/* ===== Task notebook ===== */
.notebook{ position: sticky; top: 18px; }
@media (max-width: 980px){
  .notebook{ position: static; }
}

.notebookHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}

.notebookTitle{
  font-weight:700;
  letter-spacing:-.02em;
  margin-top:2px;
}

.notebookTabs{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.notebookBody{
  padding:12px;
  display:grid;
  gap:12px;
}

</style>


  <!-- ==================================================================================================================
    =========================================================END OF STYLE=========================================================
  =================================================================================================================== -->

</head>
  <!-- ==================================================================================================================
    =========================================================START OF BODY=========================================================
  =================================================================================================================== -->
<body>
  <!-- =========================================================
    PAGE WRAP
  ========================================================== -->
  <div class="wrap">
<!-- =========================================================
  HERO / HEADER
========================================================== -->
<header class="heroBanner" aria-label="Navigation Hub banner">
  <div class="heroInner">

    <!-- Top row: kicker + badges -->
    <div class="heroTop">
      <div class="kickerPill">
        <span class="kDot" aria-hidden="true"></span>
        NAVIGATION
      </div>

      <div class="heroBadges" aria-label="Status badges">
        <span class="badgePill">1</span>
        <span class="badgePill">2</span>
      </div>
    </div>

    <!-- Center title -->
    <div class="heroCenter">
      <h1 class="heroTitle">Navigation Hub</h1>
      <p class="heroSubtitle">Webpage navigation tracking</p>
      <div class="heroDivider" aria-hidden="true"></div>
    </div>

  </div>
</header>

<!-- =========================================================
  MAIN CARD: TOOLBAR + TREE
========================================================== -->
<div class="layout2">
  <!-- LEFT: your existing navigation card -->
  <section class="card" aria-label="Navigation hub">
    ...
  </section>

  <!-- RIGHT: Task Notebook -->
  <aside class="card notebook" aria-label="Task notebook">
    <div class="notebookHead">
      <div>
        <div class="kicker">TASK NOTEBOOK</div>
        <div class="notebookTitle" id="nbTitle">Select a page to view tasks</div>
      </div>

      <div class="notebookTabs" role="tablist" aria-label="Notebook views">
        <button class="btn" id="nbTabSelected" type="button" aria-selected="true">Selected</button>
        <button class="btn" id="nbTabAll" type="button" aria-selected="false">All</button>
      </div>
    </div>

    <div class="notebookBody" id="nbBody">
      <div class="taskEmpty">Click üßæ on any item to pin its tasks here.</div>
    </div>
  </aside>
</div>

  <!-- Toolbar -->
<div class="toolbar" id="top">

  <!-- Left: section title -->
  <div class="toolbarTitle">
    Webpage Navigation
  </div>

  <!-- Center: search -->
  <div class="toolbarCenter">
    <label class="sr-only" for="search">Search</label>
    <input
      class="input"
      id="search"
      type="search"
      placeholder="Search titles, URLs, notes‚Ä¶"
    />
  </div>

  <!-- Right: Add + Actions -->
  <div class="toolbarRight">
    <button class="btn" id="addItem" type="button">Ôºã Add</button>

    <details class="menu" id="actionsMenu">
      <summary class="btn" aria-label="Actions">‚ò∞ Actions</summary>

      <div class="menuList" role="menu" aria-label="Toolbar actions">
        <button class="btn menuItem" id="expandAll">‚ñæ Expand all</button>
        <button class="btn menuItem" id="collapseAll">‚ñ∏ Collapse all</button>
        <div class="menuSep"></div>
        <button class="btn menuItem" id="exportJson">‚á™ Export JSON</button>
        <button class="btn menuItem" id="resetEdits">‚Ü∫ Reset edits</button>
      </div>
    </details>
  </div>

</div>



  <!-- Tree mount point -->
  <div class="tree" id="treeRoot"></div>
</section>


  </div>

  <!-- =========================================================
    EMBEDDED DATA (INITIAL TREE NODES)
  ========================================================== -->

  <script id="navData" type="application/json">
[
  { "type":"group", "id":"core", "title":"Core", "parentId":null, "order":1 },
  { "type":"tile",  "id":"home", "title":"Home", "href":"/index.html", "parentId":"core", "order":1 },

  { "type":"group", "id":"topics", "title":"Topics", "parentId":null, "order":2 },
  { "type":"group", "id":"animals", "title":"Animals", "parentId":"topics", "order":1, "color":"#22d3ee" },
  { "type":"tile",  "id":"animals-index", "title":"Animals", "href":"/animals/index.html", "parentId":"animals", "order":1 },
  { "type":"tile",  "id":"endangered", "title":"Endangered Animals", "href":"/animals/endangered.html", "parentId":"animals", "order":2 },

  { "type":"group", "id":"action", "title":"Take action", "parentId":null, "order":3 },
  { "type":"tile",  "id":"donate-wwf", "title":"Donate: WWF", "href":"https://www.worldwildlife.org/", "parentId":"action", "order":1 }
]
  </script>

  <!-- =========================================================
    MODAL (ADD / EDIT)
  ========================================================== -->

 <!-- ADD/EDIT MODAL -->
<div class="modalBackdrop" id="modalBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">

    <!-- Modal header -->
    <div class="modalHead">
      <div>
        <div class="kicker" id="modalKicker">ADD</div>
        <div id="modalTitle" class="modalTitle">Item</div>
      </div>

      <button class="iconBtn" id="closeModal" type="button" aria-label="Close">‚úï</button>
    </div>

    <!-- Modal body -->
    <div class="modalBody">

      <div class="grid2">
        <label class="field">
          <span>Type</span>
          <select class="input" id="fType">
            <option value="group">Page (group)</option>
            <option value="tile">Link (tile)</option>
          </select>
        </label>

        <label class="field">
          <span>Title</span>
          <input class="input" id="fTitle" placeholder="Title" />
        </label>
      </div>

      <label class="field">
        <span>Hyperlink</span>
        <input class="input" id="fHref" placeholder="https://‚Ä¶ or /path" />
      </label>

      <label class="field">
        <span>WEBPAGE TASKS (one per line)</span>
        <textarea
          class="input"
          id="fTasks"
          placeholder="- Draft copy&#10;- Add donate buttons&#10;- Proofread"
          style="min-height:120px; resize:vertical; padding-top:10px;"
        ></textarea>
      </label>

      <label class="field" id="groupColorField">
        <span>Group color</span>
        <input
          class="input"
          id="fColor"
          type="color"
          value="#6d5efc"
          style="height:44px; padding:6px 10px;"
        />
      </label>

      <div class="modalActions">
        <button class="btn" id="deleteItem" type="button">üóë Delete</button>
        <div style="flex:1"></div>
        <button class="btn" id="saveItem" type="button">üíæ Save</button>
      </div>

    </div>
  </div>
</div>


<!-- ‚úÖ TASKS MODAL (PASTE IT HERE: OUTSIDE the Add/Edit modal) -->
<div class="modalBackdrop" id="tasksBackdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="kicker">WEBPAGE TASKS</div>
        <div id="tasksTitle" class="modalTitle"></div>
      </div>
      <button class="iconBtn" id="closeTasks" type="button">‚úï</button>
    </div>

    <div class="modalBody" id="tasksBody"></div>
  </div>
</div>

  <!-- =========================================================
    VENDOR SCRIPTS (LOAD BEFORE APP SCRIPT)
  ========================================================== -->

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<!-- ==================================================================================================================
    =========================================================START OF SCRIPT=========================================================
  =================================================================================================================== -->

<script>
/* =========================================================
  Vigil ‚Äî Unlimited nesting tree
  - Nodes are either {type:"group"} or {type:"tile"}
  - parentId builds a tree (null = root)
  - Drag groups into/out of groups (infinite nesting)
  - Prevent dropping a group into its own descendant
  - Persist nodes + collapsed group state to localStorage
========================================================== */


/* =========================================================
  1) STORAGE KEYS
========================================================== */
const LS_NODES = "vigil_nodes_tree_v1";
const LS_COLLAPSED = "vigil_collapsed_groups_v1";


/* =========================================================
  2) DOM HELPERS + DOM REFERENCES
========================================================== */
const $ = (sel) => document.querySelector(sel);

// Mount points
const treeRootEl = $("#treeRoot");
const searchEl = $("#search");

// Toolbar buttons
const expandAllBtn = $("#expandAll");
const collapseAllBtn = $("#collapseAll");
const addItemBtn = $("#addItem");
const exportBtn = $("#exportJson");
const resetBtn = $("#resetEdits");
  const actionsMenu = $("#actionsMenu");
  const closeActionsMenu = () => {
  if (actionsMenu && actionsMenu.open) actionsMenu.open = false;
};

const tasksBackdrop = $("#tasksBackdrop");
const tasksTitle = $("#tasksTitle");
const tasksBody = $("#tasksBody");
const closeTasksBtn = $("#closeTasks");


// Modal elements
const modalBackdrop = $("#modalBackdrop");
const closeModalBtn = $("#closeModal");
const saveItemBtn = $("#saveItem");
const deleteItemBtn = $("#deleteItem");

const modalKicker = $("#modalKicker");
const modalTitle = $("#modalTitle");

const fType = $("#fType");
const fTitle = $("#fTitle");
  const fTasks = $("#fTasks");
const fHref = $("#fHref");
const fColor = $("#fColor");
const groupColorField = $("#groupColorField");

const nbTitle = $("#nbTitle");
const nbBody = $("#nbBody");
const nbTabSelected = $("#nbTabSelected");
const nbTabAll = $("#nbTabAll");

/* =========================================================
  3) APP STATE
========================================================== */
let filter = "";
let editingId = null;
let notebookMode = "selected";      // "selected" | "all"
let pinnedTaskNodeId = null;        // currently selected node for notebook

// Used to preserve default insert location when adding from ‚ÄúAdd here‚Äù
let draftParentId = null;
let draftOrder = 9999;

let NODES = [];
let collapsedGroups = new Set();
let _sortables = [];


/* =========================================================
  4) SMALL UTILITIES
========================================================== */
const escapeHtml = (s) => (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const copyToClipboard = async (text) => {
  try { await navigator.clipboard.writeText(text); } catch {}
};

const slugify = (s) => (s || "")
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/(^-|-$)/g, "");

/* =========================================================
  TASKS HELPERS
========================================================== */
const normalizeTasks = (node) => {
  // Support older saved nodes that don't have tasks yet
  if (!Array.isArray(node.tasks)) node.tasks = [];
  // Support legacy string tasks if you ever stored that
  if (typeof node.tasks === "string") node.tasks = [{ text: node.tasks, done:false }];
};

const tasksToTextarea = (tasks) => {
  if (!Array.isArray(tasks) || !tasks.length) return "";
  // Allow users to see completion in the editor
  return tasks.map(t => `${t?.done ? "[x] " : ""}${t?.text ?? ""}`.trimEnd()).join("\n");
};

const textareaToTasks = (value) => {
  const raw = (value || "").split("\n").map(s => s.trim()).filter(Boolean);
  return raw.map(line => {
    const done = /^\[x\]\s*/i.test(line) || /^-?\s*\[x\]\s*/i.test(line);
    const text = line.replace(/^-?\s*\[x\]\s*/i, "").replace(/^\[x\]\s*/i, "").trim();
    return { text, done };
  }).filter(t => t.text);
};
window.__openTasks = (id) => {
  pinnedTaskNodeId = id;
  notebookMode = "selected";
  renderNotebook();
};


const renderTasks = (node) => {
  const renderNotebookSelected = () => {
  if (!pinnedTaskNodeId) {
    nbTitle.textContent = "Select a page to view tasks";
    nbBody.innerHTML = `<div class="taskEmpty">Click üßæ on any item to pin its tasks here.</div>`;
    return;
  }
  const n = nodeById(pinnedTaskNodeId);
  if (!n) return;

  normalizeTasks(n);
  nbTitle.textContent = n.title || "(untitled)";
  nbBody.innerHTML = renderTasks(n);
};

const renderNotebookAll = () => {
  const nodesWithTasks = NODES
    .map(n => (normalizeTasks(n), n))
    .filter(n => Array.isArray(n.tasks) && n.tasks.length);

  nbTitle.textContent = "All tasks (across site)";

  if (!nodesWithTasks.length) {
    nbBody.innerHTML = `<div class="taskEmpty">No tasks found yet.</div>`;
    return;
  }

  nbBody.innerHTML = nodesWithTasks.map(n => `
    <div class="tasks">
      <div class="tasksHead">
        <div class="tasksLabel">${escapeHtml(n.title || n.id)}</div>
        <button class="tasksAdd" type="button" onclick="window.__taskAdd('${escapeHtml(n.id).replaceAll("'","&#039;")}')">Ôºã Add task</button>
      </div>
      ${renderTasks(n).replace(/^<div class="tasks"[\s\S]*?<div class="tasksHead">[\s\S]*?<\/div>/, "")}
    </div>
  `).join("");
};

const renderNotebook = () => {
  // update tab aria-selected
  nbTabSelected.setAttribute("aria-selected", notebookMode === "selected");
  nbTabAll.setAttribute("aria-selected", notebookMode === "all");

  if (notebookMode === "all") renderNotebookAll();
  else renderNotebookSelected();
};

  const tasks = Array.isArray(node.tasks) ? node.tasks : [];
  const rows = tasks.length
    ? `<div class="taskList">${
        tasks.map((t, idx) => `
          <div class="taskRow">
            <input class="taskCheck" type="checkbox"
              ${t.done ? "checked" : ""}
              onclick="window.__taskToggle('${escapeHtml(node.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Mark task done" />
            <div class="taskText ${t.done ? "done" : ""}">${escapeHtml(t.text)}</div>
            <button class="taskDel" type="button"
              onclick="window.__taskDelete('${escapeHtml(node.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Delete task">‚úï</button>
          </div>
        `).join("")
      }</div>`
    : `<div class="taskEmpty">No tasks yet.</div>`;

  return `
    <div class="tasks" aria-label="Webpage tasks">
      <div class="tasksHead">
        <div class="tasksLabel">WEBPAGE TASKS</div>
        <button class="tasksAdd" type="button"
          onclick="window.__taskAdd('${escapeHtml(node.id).replaceAll("'","&#039;")}')">Ôºã Add task</button>
      </div>
      ${rows}
    </div>
  `;
};

// Inline hooks
window.__taskAdd = (id) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const text = prompt("New task:");
  if (!text || !text.trim()) return;
  n.tasks.push({ text: text.trim(), done:false });
  saveNodes();
  render();
};

window.__taskToggle = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const t = n.tasks[idx];
  if (!t) return;
  t.done = !t.done;
  saveNodes();
  render();
};

window.__taskDelete = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  n.tasks.splice(idx, 1);
  saveNodes();
  render();
};

/* =========================================================
  5) LOAD / SAVE
========================================================== */
const loadEmbedded = () => {
  const el = document.getElementById("navData");
  return JSON.parse(el?.textContent || "[]");
};

const loadNodes = () => {
  const raw = localStorage.getItem(LS_NODES);
  if (raw) { try { return JSON.parse(raw); } catch {} }
  return loadEmbedded();
};

const saveNodes = () => localStorage.setItem(LS_NODES, JSON.stringify(NODES, null, 2));

const loadCollapsed = () => {
  const raw = localStorage.getItem(LS_COLLAPSED);
  if (!raw) return new Set();
  try { return new Set(JSON.parse(raw)); } catch { return new Set(); }
};

const saveCollapsed = () =>
  localStorage.setItem(LS_COLLAPSED, JSON.stringify([...collapsedGroups], null, 2));


/* =========================================================
  6) DATA ACCESSORS
========================================================== */
const nodeById = (id) => NODES.find(n => n.id === id);

const childrenOf = (parentId) =>
  NODES
    .filter(n => (n.parentId ?? null) === (parentId ?? null))
    .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));

const buildDescendantsSet = (groupId) => {
  const out = new Set();
  const stack = [groupId];

  while (stack.length) {
    const cur = stack.pop();
    for (const ch of childrenOf(cur)) {
      out.add(ch.id);
      if (ch.type === "group") stack.push(ch.id);
    }
  }
  return out;
};

const normalizeOrders = () => {
  const parents = new Set(NODES.map(n => n.parentId ?? null));
  for (const p of parents) {
    const kids = childrenOf(p);
    kids.forEach((n, idx) => (n.order = idx + 1));
  }
};


/* =========================================================
  7) SEARCH / FILTER VISIBILITY
========================================================== */
const matchNode = (n) => {
  if (!filter) return true;
  normalizeTasks(n);
  const taskText = (n.tasks || []).map(t => t.text).join(" ");
  const hay = `${n.title||""} ${n.href||""} ${n.notes||""} ${n.kind||""} ${taskText}`.toLowerCase();
  return hay.includes(filter);
};


const visibleSetForFilter = () => {
  if (!filter) return null;

  const visible = new Set();
  const byParent = new Map();

  for (const n of NODES) {
    const p = n.parentId ?? null;
    if (!byParent.has(p)) byParent.set(p, []);
    byParent.get(p).push(n);
  }

  const hasMatchInSubtree = (id) => {
    const n = nodeById(id);
    if (!n) return false;
    if (matchNode(n)) return true;
    if (n.type !== "group") return false;
    const kids = byParent.get(id) || [];
    return kids.some(k => hasMatchInSubtree(k.id));
  };

  const ensureAncestors = (id) => {
    let cur = nodeById(id);
    while (cur) {
      visible.add(cur.id);
      if (cur.parentId == null) break;
      cur = nodeById(cur.parentId);
    }
  };

  for (const n of NODES) {
    if (hasMatchInSubtree(n.id)) ensureAncestors(n.id);
  }

  return visible;
};


/* =========================================================
  8) MODAL: OPEN / CLOSE / UI
========================================================== */
const showModal = () => modalBackdrop.removeAttribute("hidden");
const hideModal = () => modalBackdrop.setAttribute("hidden", "");

const setTypeUI = () => {
  const isGroup = fType.value === "group";
  groupColorField.style.display = isGroup ? "grid" : "none";
};

const openModal = (node, isNew, forceType = null) => {
  showModal();

  editingId = isNew ? null : node.id;

  // Preserve where the Add button was clicked
  draftParentId = isNew ? (node.parentId ?? null) : null;
  draftOrder = isNew ? (node.order ?? 9999) : 9999;

  modalKicker.textContent = isNew ? "ADD" : "EDIT";
  modalTitle.textContent = isNew ? "New item" : (node.title || node.id || "Item");

  fType.value = forceType ?? (node.type || "tile");
  setTypeUI();

  fTitle.value = node.title || "";
  fHref.value  = node.href  || "";
  fColor.value = node.color || "#6d5efc";
  
  normalizeTasks(node);
fTasks.value = tasksToTextarea(node.tasks);


  deleteItemBtn.style.display = isNew ? "none" : "inline-flex";

  setTimeout(() => fTitle.focus(), 0);
};

const closeModal = () => {
  hideModal();
  editingId = null;
};
closeTasksBtn.addEventListener("click", () => {
  tasksBackdrop.setAttribute("hidden","");
});

tasksBackdrop.addEventListener("click", (e) => {
  if (e.target === tasksBackdrop)
    tasksBackdrop.setAttribute("hidden","");
});


/* =========================================================
  9) CRUD (UPSERT / DELETE)
========================================================== */
const upsert = (updated) => {
  const idx = NODES.findIndex(x => x.id === updated.id);
  if (idx >= 0) NODES[idx] = { ...NODES[idx], ...updated };
  else NODES.push(updated);

  normalizeOrders();
  saveNodes();
  render();
};

const removeNode = (id) => {
  const n = nodeById(id);
  if (!n) return;

  const toDelete = new Set([id]);
  if (n.type === "group") {
    for (const d of buildDescendantsSet(id)) toDelete.add(d);
  }

  for (const x of toDelete) collapsedGroups.delete(x);

  NODES = NODES.filter(x => !toDelete.has(x.id));
  normalizeOrders();
  saveCollapsed();
  saveNodes();
  render();
};


/* =========================================================
  10) RENDER TEMPLATES
========================================================== */
// Universal ‚ÄúAdd here‚Äù button (user picks type in modal)
const renderAddButton = (parentId) => {
  const pid = parentId ?? null;
  return `
    <button class="dropHint" type="button"
      onclick="window.__addAt('${escapeHtml(pid ?? "__root__").replaceAll("'","&#039;")}')">
      Ôºã Add here
    </button>
  `;
};

// Called by ‚ÄúAdd here‚Äù
window.__addAt = (parentRaw) => {
  const parentId = (parentRaw === "__root__") ? null : parentRaw;
  openModal(
    { type:"tile", id:"", title:"", href:"", parentId, notes:"", order:9999 },
    true,
    null // let user choose group/tile
  );
};

const renderTile = (n) => {
  const chip = `<span class="chip">Link</span>`;
  const notes = n.notes ? `<div class="notes">${escapeHtml(n.notes)}</div>` : "";
  const href = n.href || "#";
  const target = href.startsWith("/") ? "" : `target="_blank" rel="noreferrer noopener"`;

  return `
    <div class="tile treeItem" data-id="${escapeHtml(n.id)}" data-type="tile">
      <div class="tileMain">
        <a href="${escapeHtml(href)}" ${target}
           style="text-decoration:none; color:inherit; display:block;">
          <div class="tileTitleLine">
            <span class="tileTitle">${escapeHtml(n.title || "(untitled)")}</span>
            ${chip}
          </div>
          <div class="url">${escapeHtml(href)}</div>
        </a>
        ${notes}
      </div>

      <div class="actions">
      <button class="iconBtn" type="button"
  onclick="window.__openTasks('${escapeHtml(n.id).replaceAll("'","&#039;")}')"
  aria-label="Open tasks">üßæ</button>

        <button class="iconBtn" type="button"
          onclick="window.__edit('${escapeHtml(n.id).replaceAll("'","&#039;")}')">‚úé</button>

        <button class="iconBtn" type="button"
          onclick="window.__copy('${escapeHtml(href).replaceAll("'","&#039;")}')">‚ßâ</button>

        <div class="dragHandle" role="button" tabindex="0"
             aria-label="Drag to move tile"
             title="Drag to move">‚ãÆ‚ãÆ</div>
      </div>
    </div>
  `;
};

const renderGroup = (g, visibleSet, depth) => {
  const kids = childrenOf(g.id)
    .filter(n => !visibleSet || visibleSet.has(n.id));

  const collapsed = collapsedGroups.has(g.id) && !filter;

  const body = collapsed ? "" : (
    kids.length
      ? kids.map(n => n.type === "group"
          ? renderGroup(n, visibleSet, depth + 1)
          : renderTile(n)
        ).join("")
      : `${renderAddButton(g.id)}`
  );

  const indentClass = depth > 0 ? "indent" : "";
  const accentStyle = g.color
    ? `style="border-left:6px solid ${escapeHtml(g.color)};"`
    : "";

  return `
    <div class="node treeItem ${indentClass}" data-id="${escapeHtml(g.id)}" data-type="group" ${accentStyle}>
      <div class="nodeHeader">
        <div class="nodeHeaderLeft">
          <button class="twisty" type="button" aria-label="Toggle group"
            onclick="window.__toggle('${escapeHtml(g.id).replaceAll("'","&#039;")}')">
            ${collapsed ? "‚ñ∏" : "‚ñæ"}
          </button>

          <div style="min-width:0">
            ${(() => {
              const title = escapeHtml(g.title || "(group)");
              const href = g.href;

              if (!href) return `<div class="nodeTitle">${title}</div>`;

              const target = href.startsWith("/") ? "" : `target="_blank" rel="noreferrer noopener"`;
              return `
                <a class="nodeTitle" href="${escapeHtml(href)}" ${target}
                   style="text-decoration:none; color:inherit;">
                  ${title}
                </a>
                <div class="url" style="margin-top:4px">${escapeHtml(href)}</div>
              `;
            })()}

            ${g.notes ? `<div class="notes" style="margin-top:2px">${escapeHtml(g.notes)}</div>` : ``}
          </div>
        </div>

        <div class="actions">
        <button class="iconBtn" type="button"
  onclick="window.__openTasks('${escapeHtml(g.id).replaceAll("'","&#039;")}')"
  aria-label="Open tasks">üßæ</button>

          <button class="iconBtn" type="button"
            onclick="window.__edit('${escapeHtml(g.id).replaceAll("'","&#039;")}')">‚úé</button>

          <button class="iconBtn" type="button"
            onclick="window.__copy('${escapeHtml(g.href || "").replaceAll("'","&#039;")}')">‚ßâ</button>

          <div class="dragHandle" role="button" tabindex="0"
               aria-label="Drag to move group"
               title="Drag to move">‚ãÆ‚ãÆ</div>
        </div>
      </div>

      <div class="nodeBody"
           ${collapsed ? "hidden" : ""}
           data-container="children"
           data-parent-id="${escapeHtml(g.id)}">
        ${body}
        ${(!collapsed && kids.length) ? `${renderAddButton(g.id)}` : ``}
      </div>
    </div>
  `;
};

const renderRoot = () => {
  const visibleSet = visibleSetForFilter();

  const roots = childrenOf(null)
    .filter(n => !visibleSet || visibleSet.has(n.id));

  if (!roots.length) {
    treeRootEl.innerHTML = `
      <div class="dropHint">No matches. Try a different search.</div>
      ${renderAddButton(null)}
    `;
    return;
  }

  treeRootEl.innerHTML = `
    <div data-container="children" data-parent-id="__root__">
      ${roots.map(n => n.type === "group" ? renderGroup(n, visibleSet, 0) : renderTile(n)).join("")}
    </div>
  `;
};


/* =========================================================
  11) SORTABLE (DRAG/DROP)
========================================================== */
const destroySortables = () => {
  _sortables.forEach(s => { try { s.destroy(); } catch {} });
  _sortables = [];
};

const rebuildFromDOM = () => {
  document.querySelectorAll('[data-container="children"]').forEach((containerEl) => {
    const p = containerEl.dataset.parentId;
    const parentId = (p === "__root__") ? null : p;

    const items = [...containerEl.children].filter(el => el.classList.contains("treeItem"));
    items.forEach((el, idx) => {
      const id = el.dataset.id;
      const n = nodeById(id);
      if (!n) return;
      n.parentId = parentId;
      n.order = idx + 1;
    });
  });

  normalizeOrders();
  saveNodes();
};

const isDescendant = (maybeChildId, maybeAncestorId) => {
  const desc = buildDescendantsSet(maybeAncestorId);
  return desc.has(maybeChildId);
};

const initSortables = () => {
  destroySortables();

  const containers = document.querySelectorAll('[data-container="children"]');

  containers.forEach((containerEl) => {
    const s = new Sortable(containerEl, {
      group: "vigil-tree",
      animation: 150,
      draggable: ".treeItem",
      handle: ".dragHandle",
      filter: "a, button",
      preventOnFilter: true,
      fallbackOnBody: true,

      onMove: (evt) => {
        const draggedEl = evt.dragged;
        const draggedId = draggedEl?.dataset?.id;
        const draggedType = draggedEl?.dataset?.type;

        const toContainer = evt.to;
        const toParentRaw = toContainer?.dataset?.parentId;
        const toParentId = (toParentRaw === "__root__") ? null : toParentRaw;

        if (!draggedId) return true;

        // Block dropping into itself
        if (toParentId === draggedId) return false;

        // Block dropping a group into its own descendant
        if (draggedType === "group" && toParentId) {
          if (isDescendant(toParentId, draggedId)) return false;
        }

        return true;
      },

      onEnd: () => {
        rebuildFromDOM();
        render();
      }
    });

    _sortables.push(s);
  });
};


/* =========================================================
  12) RENDER PIPELINE
========================================================== */
const render = () => {
  renderRoot();
  initSortables();
  renderNotebook();
};



/* =========================================================
  13) PUBLIC HOOKS (USED BY INLINE onclick)
========================================================== */
window.__toggle = (groupId) => {
  if (collapsedGroups.has(groupId)) collapsedGroups.delete(groupId);
  else collapsedGroups.add(groupId);
  saveCollapsed();
  render();
};

window.__copy = (href) => copyToClipboard(href);

window.__edit = (id) => {
  const n = nodeById(id);
  if (!n) return;
  openModal(n, false);
};


/* =========================================================
  14) UI ACTIONS
========================================================== */
const setAllCollapsed = (collapsed) => {
  const allGroups = NODES.filter(n => n.type === "group").map(n => n.id);
  collapsedGroups = new Set(collapsed ? allGroups : []);
  saveCollapsed();
  render();
};


/* =========================================================
  15) EVENTS
========================================================== */
  nbTabSelected.addEventListener("click", () => {
  notebookMode = "selected";
  renderNotebook();
});

nbTabAll.addEventListener("click", () => {
  notebookMode = "all";
  renderNotebook();
});

// Search
searchEl.addEventListener("input", (e) => {
  filter = (e.target.value || "").trim().toLowerCase();
  render();
});

// Expand/collapse
expandAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(false); });
collapseAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(true); });

exportBtn.addEventListener("click", async () => {
  closeActionsMenu();
  const json = JSON.stringify(NODES, null, 2);
  try {
    await navigator.clipboard.writeText(json);
    alert("Copied tree JSON to clipboard.");
  } catch {
    console.log(json);
    alert("Could not copy automatically. Check console for JSON.");
  }
});

resetBtn.addEventListener("click", () => {
  closeActionsMenu();
  if (!confirm("Clear saved edits on this device?")) return;
  localStorage.removeItem(LS_NODES);
  localStorage.removeItem(LS_COLLAPSED);
  location.reload();
});
  document.addEventListener("click", (e) => {
  if (!actionsMenu) return;
  if (actionsMenu.open && !actionsMenu.contains(e.target)) actionsMenu.open = false;
});


// Global add button (top-right)
addItemBtn.addEventListener("click", () => {
  openModal(
    { type:"tile", id:"", title:"", href:"", parentId:null, notes:"", order:9999 },
    true,
    null
  );
});

// Modal close
closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !modalBackdrop.hasAttribute("hidden")) closeModal();
});

// Modal type UI toggle
fType.addEventListener("change", setTypeUI);

// Save
saveItemBtn.addEventListener("click", () => {
  const type  = (fType.value || "tile").trim(); // group | tile
  const title = (fTitle.value || "").trim();
  const href  = (fHref.value || "").trim();
  const color = (fColor?.value || "").trim();

  if (!title) return alert("Title is required.");
  if (!href)  return alert("Hyperlink is required.");

  // Keep id when editing; generate id when creating
  let id = editingId ? editingId : (slugify(title) || "item");

  // If creating new and collision occurs, suffix -2, -3, ...
  if (!editingId) {
    const base = id;
    let n = 2;
    while (NODES.some(x => x.id === id)) id = `${base}-${n++}`;
  }

  const existing = nodeById(id);

  const updated = {
    id,
    type,
    title,
    href,
    parentId: existing?.parentId ?? draftParentId ?? null,
    order: existing?.order ?? draftOrder ?? 9999,
     tasks: textareaToTasks(fTasks.value),
  };

  if (type === "group") updated.color = color || "#6d5efc";
  else delete updated.color;

  upsert(updated);
  closeModal();
});

// Delete
deleteItemBtn.addEventListener("click", () => {
  if (!editingId) return;
  if (!confirm("Delete this item? (Groups delete their entire subtree)")) return;
  removeNode(editingId);
  closeModal();
});

// Export
exportBtn.addEventListener("click", async () => {
  const json = JSON.stringify(NODES, null, 2);
  try {
    await navigator.clipboard.writeText(json);
    alert("Copied tree JSON to clipboard.");
  } catch {
    console.log(json);
    alert("Could not copy automatically. Check console for JSON.");
  }
});

// Reset (clear localStorage)
resetBtn.addEventListener("click", () => {
  if (!confirm("Clear saved edits on this device?")) return;
  localStorage.removeItem(LS_NODES);
  localStorage.removeItem(LS_COLLAPSED);
  location.reload();
});


/* =========================================================
  16) BOOT
========================================================== */
NODES = loadNodes();
collapsedGroups = loadCollapsed();
  NODES.forEach(normalizeTasks);
normalizeOrders();
saveNodes();
setTypeUI();
render();

</script>

  <!-- ==================================================================================================================
    =========================================================END OF SCRIPT=========================================================
  =================================================================================================================== -->

</body>
 <!-- ==================================================================================================================
    =========================================================END OF BODY=========================================================
  =================================================================================================================== -->
</html>
