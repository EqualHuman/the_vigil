<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Navigation Hub</title>
  <meta name="color-scheme" content="dark light" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

<!-- ==================================================================================================================
=========================================================START OF STYLE=========================================================
=================================================================================================================== -->


<style>
/* =========================================================
  0) RESET / ACCESSIBILITY
========================================================== */
[hidden]{display:none!important;}
*{box-sizing:border-box;}
.sr-only{
  position:absolute;width:1px;height:1px;
  padding:0;margin:-1px;overflow:hidden;
  clip:rect(0,0,0,0);border:0;
}

/* =========================================================
  1) THEME TOKENS (CSS VARIABLES)
========================================================== */
:root{
  --bg0:#050510;
  --bg1:#070a1c;

  --panel: rgba(255,255,255,.07);
  --panel-2: rgba(255,255,255,.045);
  --border: rgba(255,255,255,.14);

  --text: rgba(255,255,255,.93);
  --muted: rgba(255,255,255,.68);
  --muted2: rgba(255,255,255,.55);

  --accentA:#6d5efc;
  --accentB:#22d3ee;
  --accentC:#ff4fd8;

  --shadow: 0 18px 70px rgba(0,0,0,.55);
  --ring: 0 0 0 3px rgba(34,211,238,.22);
  --radius: 20px;
  --ease: cubic-bezier(.2,.8,.2,1);

  --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: "Space Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --serif: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;

  --ornA: rgba(34,211,238,.55);
  --ornB: rgba(109,94,252,.55);
  --ink:  rgba(6,7,20,.88);
  --ink2: rgba(10,12,28,.72);
}

/* =========================================================
  2) PAGE / LAYOUT
========================================================== */
body{
  margin:0;
  font-family:var(--sans);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  position:relative;

  background:
    radial-gradient(900px 520px at 15% 10%, color-mix(in oklab, var(--accentB), transparent 78%), transparent 65%),
    radial-gradient(900px 520px at 90% 20%, color-mix(in oklab, var(--accentA), transparent 80%), transparent 60%),
    radial-gradient(1100px 650px at 50% 110%, color-mix(in oklab, var(--accentC), transparent 82%), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

body::before{
  content:"";
  position:fixed;
  inset:-40px;
  pointer-events:none;
  z-index:-1;
  background:
    radial-gradient(closest-side at 25% 25%, rgba(34,211,238,.18), transparent 60%),
    radial-gradient(closest-side at 75% 35%, rgba(109,94,252,.16), transparent 62%),
    radial-gradient(closest-side at 55% 75%, rgba(255,79,216,.14), transparent 60%);
  filter: blur(22px);
  opacity:.9;
  animation:none !important;
}

.wrap{
  max-width: 980px;
  margin:0 auto;
  padding:28px 18px 60px;
}

/* =========================================================
  3) HERO BANNER
========================================================== */
.heroBanner{
  position:relative;
  margin:14px auto 18px;
  border-radius: calc(var(--radius) + 14px);
  overflow:hidden;
  isolation:isolate;
  min-height:132px;
  max-width: 980px;

  background:
    radial-gradient(900px 260px at 50% 0%, rgba(255,255,255,.09), transparent 62%),
    radial-gradient(900px 380px at 15% 40%, rgba(34,211,238,.12), transparent 62%),
    radial-gradient(900px 380px at 85% 40%, rgba(109,94,252,.12), transparent 62%),
    linear-gradient(180deg, var(--ink), var(--ink2));

  border: 1px solid rgba(255,255,255,.10);
  box-shadow:
    0 22px 90px rgba(0,0,0,.55),
    inset 0 0 0 1px rgba(255,255,255,.06),
    inset 0 0 60px rgba(109,94,252,.08),
    inset 0 0 120px rgba(34,211,238,.06);

  backdrop-filter: blur(10px);
}

.heroBanner::before{
  content:"";
  position:absolute;
  inset:0;
  padding:1px;
  border-radius: inherit;
  pointer-events:none;
  opacity:.95;
  background: linear-gradient(135deg,
    rgba(34,211,238,.0),
    rgba(34,211,238,.22),
    rgba(109,94,252,.18),
    rgba(255,79,216,.10),
    rgba(34,211,238,.0)
  );
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
}

.heroBanner::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;
  background:
    linear-gradient(120deg, transparent 35%, rgba(255,255,255,.10), transparent 65%),
    radial-gradient(140% 90% at 50% 0%, rgba(255,255,255,.08), transparent 55%),
    linear-gradient(90deg, rgba(0,0,0,.28), transparent 26%, transparent 74%, rgba(0,0,0,.28));
  background-size: 240% 100%, 100% 100%, 100% 100%;
  background-position: -40% 0, 0 0, 0 0;
  animation:none !important;
  opacity:.25 !important;
  mix-blend-mode: normal !important;
}

.heroInner{
  position:relative;
  z-index:1;
  display:grid;
  grid-template-rows:auto 1fr;
  align-content:center;
  padding:18px 22px;
  text-align:center;
}

.heroTop{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.heroCenter{
  display:grid;
  justify-items:center;
  align-content:center;
  max-width:760px;
  margin:0 auto;
}

.heroTitle{
  margin:0 0 6px;
  font-family: var(--serif);
  font-weight:650;
  font-size: clamp(38px, 5vw, 58px);
  line-height:.98;
  letter-spacing:.04em;
  text-transform:uppercase;
  color: rgba(255,255,255,.92);
  text-shadow: 0 22px 90px rgba(0,0,0,.65);
}

.heroSubtitle{
  margin:0;
  font-size:12px;
  letter-spacing:.28em;
  text-transform:uppercase;
  color: rgba(255,255,255,.62);
  opacity:.9;
}

/* Laser line used for hero + section headers */
.heroLaser{
  position:absolute;
  left:18px;
  right:18px;
  height:2px;
  border-radius:999px;
  opacity:.95;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    color-mix(in oklab, var(--accentB), rgba(255,255,255,.70) 40%),
    color-mix(in oklab, var(--accentA), rgba(255,255,255,.70) 40%),
    color-mix(in oklab, var(--accentC), rgba(255,255,255,.70) 35%),
    rgba(255,255,255,0)
  );

  box-shadow:
    0 0 10px rgba(255,79,216,.18),
    0 0 18px rgba(109,94,252,.14),
    0 0 22px rgba(34,211,238,.10);
}
.heroLaserTop{ top:14px; }
.heroLaserBottom{ bottom:14px; }

/* =========================================================
  4) CARD + TOOLBAR
========================================================== */
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.14);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:visible;
  backdrop-filter: blur(10px);
}

.toolbar,
.notebookHead{
  position:relative;
  border-bottom:none !important;
  background:
    radial-gradient(900px 240px at 15% 0%, rgba(34,211,238,.10), transparent 60%),
    radial-gradient(900px 240px at 85% 0%, rgba(109,94,252,.10), transparent 60%),
    radial-gradient(700px 220px at 50% 0%, rgba(255,79,216,.10), transparent 62%),
    rgba(255,255,255,.03) !important;
}

.toolbar{
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  padding:14px 12px;
}

/* edge lasers flush to the box edges */
.toolbar::before,
.toolbar::after,
.notebookHead::before,
.notebookHead::after{
  content:"";
  position:absolute;
  left:0;
  right:0;
  height:2px;
  border-radius:999px;
  opacity:.95;
  pointer-events:none;

  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    color-mix(in oklab, var(--accentC), rgba(255,255,255,.70) 45%),
    color-mix(in oklab, var(--accentA), rgba(255,255,255,.70) 45%),
    color-mix(in oklab, var(--accentB), rgba(255,255,255,.62) 40%),
    rgba(255,255,255,0)
  );

  box-shadow:
    0 0 12px rgba(255,79,216,.16),
    0 0 18px rgba(109,94,252,.12),
    0 0 22px rgba(34,211,238,.10);
}
.toolbar::before,.notebookHead::before{ top:0; }
.toolbar::after,.notebookHead::after{ bottom:0; }

.toolbarTitle{
  font-size:11px;
  letter-spacing:.30em;
  text-transform:uppercase;
  white-space:nowrap;
  font-weight:500;
  padding-left:6px;
  padding-right:14px;
  border-right: 1px solid rgba(255,255,255,.12);
  opacity:.78;
  color: color-mix(in oklab, var(--accentC), rgba(255,255,255,.90) 82%);
}

.toolbarCenter{
  display:flex;
  align-items:center;
  gap:10px;
  flex: 1 1 360px;
  justify-content:center;
}

.toolbarRight{
  display:flex;
  align-items:center;
  gap:8px;
  margin-left:auto;
  justify-content:flex-end;
  flex-wrap:wrap;
  flex:0 0 auto;
}

/* =========================================================
  5) BUTTONS + INPUTS
========================================================== */
.btn{
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  color: rgba(255,255,255,.86);
  padding:7px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
  letter-spacing:.04em;

  display:inline-flex;
  align-items:center;
  gap:8px;
  user-select:none;

  box-shadow:
    0 14px 40px rgba(0,0,0,.30),
    inset 0 1px 0 rgba(255,255,255,.08);

  transition:
    transform .12s var(--ease),
    background .2s var(--ease),
    box-shadow .2s var(--ease),
    border-color .2s var(--ease);
}

.btn:hover{
  transform: translateY(-1px);
  border-color: rgba(34,211,238,.26);
  box-shadow:
    0 18px 55px rgba(0,0,0,.35),
    0 0 0 3px rgba(34,211,238,.10);
}
.btn:active{ transform: translateY(0) scale(.99); }

.input{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  color:var(--text);
  padding:8px 10px;
  border-radius:12px;
  font-size:13px;
  min-width:260px;
  max-width:520px;
  width: min(520px, 100%);
  transition: box-shadow .2s var(--ease), border-color .2s var(--ease);
}

.input:focus{
  outline:none;
  border-color: color-mix(in oklab, var(--accentB), rgba(255,255,255,.16) 40%);
  box-shadow: 0 0 0 3px rgba(34,211,238,.18);
}

select.input{ appearance:none; }

/* =========================================================
  6) TREE / NODES / TILES
========================================================== */
.tree{
  padding:12px;
  display:grid;
  gap:16px;
}

.dropHint{
  padding:10px 12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.22);
  background: rgba(255,255,255,.03);
  color: rgba(255,255,255,.65);
  font-size:12.5px;
  cursor:pointer;
  text-align:left;
}
.dropHint:hover{
  background: rgba(255,255,255,.05);
  border-color: rgba(255,255,255,.30);
}
.dropHint:focus-visible{ outline:none; box-shadow: var(--ring); }

.node{
  position:relative;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow: var(--shadow);
  overflow:hidden;
}

/* accent strips on both edges */
.node[data-accent="1"]::before,
.node[data-accent="1"]::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:6px;
  background: var(--accentStrip, rgba(255,255,255,.35));
  opacity:.95;
  pointer-events:none;
  filter: saturate(1.1);
}
.node[data-accent="1"]::before{ left:0; }
.node[data-accent="1"]::after{ right:0; }

.nodeHeader{
  display:grid;
  grid-template-columns: 1fr auto;
  align-items:center;
  gap:12px;
  padding:12px 14px;
  user-select:none;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.node[data-accent="1"] .nodeHeader,
.node[data-accent="1"] .nodeBody{
  padding-left:18px;
  padding-right:18px;
}

.nodeHeaderLeft{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}

.twisty{
  width:28px;height:28px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  cursor:pointer;
  flex:0 0 auto;
}
.twisty:hover{ background: rgba(255,255,255,.10); }

.nodeTitle{
  font-weight:750;
  letter-spacing:-.01em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}

.nodeBody{
  padding:12px;
  display:grid;
  gap:14px;
}
.nodeBody > .node{ margin-top:6px; }

.tile{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:default;
  transition:
    transform .14s var(--ease),
    background .2s var(--ease),
    border-color .2s var(--ease);
}
.tile:hover{
  transform: translateY(-1px);
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
}

.tileMain{ flex:1 1 auto; min-width:0; }

.tileTitleLine{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:4px;
}
.tileTitle{ font-weight:650; letter-spacing:-.01em; }

.chip{
  font-size:11.5px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  color:var(--muted);
}

.notes{
  margin-top:6px;
  font-size:12.5px;
  color:var(--muted2);
  line-height:1.45;
}

.actions{
  display:flex;
  align-items:center;
  gap:8px;
  flex:0 0 auto;
  margin-left:auto;
}

.iconBtn{
  width:36px;height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  cursor:pointer;
  display:grid;
  place-items:center;
  transition:
    transform .12s var(--ease),
    background .2s var(--ease),
    box-shadow .2s var(--ease);
}
.iconBtn:hover{
  background: rgba(255,255,255,.10);
  box-shadow: 0 0 0 3px rgba(109,94,252,.12);
}
.iconBtn:active{ transform: translateY(1px); }
.iconBtn:focus-visible{ outline:none; box-shadow: var(--ring); }
.iconBtn.active{
  border-color: rgba(34,211,238,.35);
  box-shadow: 0 0 0 3px rgba(34,211,238,.12);
  background: rgba(34,211,238,.08);
}

.indent{
  margin-left:14px;
  border-left:1px solid rgba(255,255,255,.10);
  padding-left:12px;
}
.node.indent{
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.025));
}
.node.indent .nodeHeader{ padding:10px 14px; }
.node.indent .nodeTitle{ font-weight:600; opacity:.92; }

[data-container="children"]{
  display:grid;
  gap:14px;
}
.tree > [data-container="children"]{ gap:18px; }

.dragHandle{
  width:36px;height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  cursor:grab;
  user-select:none;
  font-family: var(--mono);
  font-size:16px;
  line-height:1;
  opacity:.9;
  transition:
    transform .12s var(--ease),
    background .2s var(--ease),
    box-shadow .2s var(--ease);
}
.dragHandle:hover{
  background: rgba(255,255,255,.10);
  box-shadow: 0 0 0 3px rgba(34,211,238,.12);
}
.dragHandle:active{ cursor:grabbing; transform: translateY(1px); }

/* =========================================================
  7) MODAL
========================================================== */
.modalBackdrop{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.55);
  display:grid;
  place-items:center;
  padding:18px;
  z-index:50;
}

.modal{
  width:min(860px, 96vw);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  box-shadow:0 30px 120px rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.modalHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(255,255,255,.10);
}

.kicker{
  font-size:11px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color: color-mix(in oklab, var(--muted), transparent 12%);
  opacity:.95;
}

.modalTitle{ font-weight:700; letter-spacing:-.02em; }
.modalBody{ padding:14px; display:grid; gap:12px; }

.field{ display:grid; gap:6px; }
.field > span{ font-size:12px; color:var(--muted2); }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
@media (max-width:720px){ .grid2{ grid-template-columns: 1fr; } }

.modalActions{
  display:flex;
  align-items:center;
  gap:10px;
  padding-top:6px;
}

/* =========================================================
  8) DROPDOWN MENU
========================================================== */
.menu{ position:relative; }
.menu > summary{ list-style:none; }
.menu > summary::-webkit-details-marker{ display:none; }

.menuList{
  position:absolute;
  top: calc(100% + 10px);
  right: 0;
  min-width: 190px;
  padding:10px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,12,28,.85);
  backdrop-filter: blur(10px);
  box-shadow: 0 22px 80px rgba(0,0,0,.55);
  display:grid;
  gap:8px;
  z-index:20;
}

.menuItem{ width:100%; justify-content:flex-start; }

.menuSep{
  height:1px;
  background: rgba(255,255,255,.10);
  margin:6px 2px;
  border-radius:999px;
}

/* =========================================================
  10) TASKS (Notebook cards)
========================================================== */
.tasks{
  position:relative;
  margin-top:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  padding:10px 10px 8px;
}
.tasks[data-accent="1"]::before,
.tasks[data-accent="1"]::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:6px;
  background: var(--accentStrip, rgba(255,255,255,.35));
  opacity:.95;
  pointer-events:none;
}
.tasks[data-accent="1"]::before{ left:0; }
.tasks[data-accent="1"]::after{ right:0; }

.tasks[data-accent="1"]{
  padding-left:16px;
  padding-right:16px;
}

.tasksHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}

.tasksLabel{
  font-size:10.5px;
  letter-spacing:.28em;
  text-transform:uppercase;
  color: rgba(255,255,255,.62);
  user-select:none;
}
.tasks[data-accent="1"] .tasksLabel{
  color: color-mix(in oklab, var(--accentStrip), rgba(255,255,255,.80) 78%);
}

.tasksAdd{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.78);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
}
.tasksAdd:hover{ background: rgba(255,255,255,.09); }

.taskList{ display:grid; gap:6px; }

.taskRow{
  display:flex;
  align-items:flex-start;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.taskRow:hover{ background: rgba(255,255,255,.055); }

.taskCheck{
  width:18px;
  height:18px;
  margin-top:1px;
  accent-color: var(--accentB);
  cursor:pointer;
  flex:0 0 auto;
}

.taskText{
  flex:1 1 auto;
  font-size:12.5px;
  color: rgba(255,255,255,.78);
  line-height:1.35;
  word-break: break-word;
}
.taskText.done{
  opacity:.55;
  text-decoration: line-through;
}

.taskDel{
  width:30px;height:30px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.05);
  cursor:pointer;
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.taskDel:hover{ background: rgba(255,255,255,.09); }

.taskEmpty{
  font-size:12.5px;
  color: rgba(255,255,255,.55);
  padding:6px 2px 2px;
}

/* =========================================================
  11) 2-COLUMN LAYOUT + NOTEBOOK
========================================================== */
.layout2{
  display:grid;
  grid-template-columns: minmax(360px, 470px) minmax(420px, 1fr);
  gap:14px;
  align-items:start;
}
@media (max-width: 980px){
  .layout2{ grid-template-columns: 1fr; }
}

.notebook{ position: sticky; top: 18px; }
@media (max-width: 980px){
  .notebook{ position: static; }
}

.notebookHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  padding:14px;
}

.notebookTitle{
  font-weight:700;
  letter-spacing:-.02em;
  margin-top:2px;
  color: rgba(255,255,255,.90);
}

.notebookTabs{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.notebookBody{
  padding:12px;
  display:grid;
  gap:12px;
}

/* =========================================================
  12) HERO NAV DOTS
========================================================== */
.heroDots{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
}

.navDot{
  width:14px;
  height:14px;
  border-radius:50%;
  display:inline-block;
  cursor:pointer;
  position:relative;

  background:
    radial-gradient(circle at 35% 35%,
      rgba(255,255,255,1),
      rgba(255,255,255,.6) 18%,
      rgba(255,79,216,.8) 35%,
      rgba(109,94,252,.9) 55%,
      rgba(34,211,238,.9) 70%,
      transparent 100%
    );

  box-shadow:
    0 0 6px rgba(255,255,255,.9),
    0 0 16px rgba(255,79,216,.85),
    0 0 28px rgba(109,94,252,.85),
    0 0 48px rgba(34,211,238,.65);

  transition:
    transform .18s var(--ease),
    box-shadow .25s var(--ease),
    opacity .25s var(--ease);
}

.navDot::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,.9), transparent 65%);
  opacity:.35;
  filter: blur(6px);
  pointer-events:none;
}

.navDot:hover{
  transform: scale(1.35);
  box-shadow:
    0 0 8px rgba(255,255,255,1),
    0 0 22px rgba(255,79,216,1),
    0 0 40px rgba(109,94,252,1),
    0 0 70px rgba(34,211,238,.85);
}

.navDot:focus-visible{
  outline:none;
  box-shadow:
    0 0 0 3px rgba(34,211,238,.7),
    0 0 30px rgba(34,211,238,.8);
}

/* =========================================================
  13) MOTION / PERFORMANCE
========================================================== */
@media (prefers-reduced-motion: reduce){
  body::before{ animation:none !important; }
  .btn, .tile, .iconBtn, .twisty, .dragHandle{ transition:none !important; }
  .heroBanner::after{ animation:none !important; }
}

/* =========================================================
  TOOLBAR: buttons above search (clean header)
========================================================== */

/* Make toolbar a 2-row grid */
.toolbar{
  display:grid !important;
  grid-template-columns: 1fr auto;
  grid-template-areas:
    "title actions"
    "search search";
  gap:10px 12px !important;
  align-items:center;
}

/* Place items */
.toolbarTitle{ grid-area:title; border-right:none !important; padding-right:0 !important; }

.toolbarRight{
  grid-area:actions;
  margin-left:0 !important;
  justify-content:flex-end;
}

.toolbarCenter{
  grid-area:search;
  justify-content:flex-start !important;
}

/* Make search span nicely */
.toolbarCenter .input{
  min-width: 0 !important;
  width: 100% !important;
  max-width: none !important;
}

/* Optional: on small screens keep title + buttons neat */
@media (max-width: 560px){
  .toolbar{
    grid-template-columns: 1fr;
    grid-template-areas:
      "title"
      "actions"
      "search";
  }
  .toolbarRight{ justify-content:flex-start; }
}


/* =========================================================
  HERO: shiny bars flush to banner edge
========================================================== */
.heroLaser{
  left:0 !important;
  right:0 !important;
  border-radius: 999px;
}

.heroLaserTop{ top:0 !important; }
.heroLaserBottom{ bottom:0 !important; }

/* Give inner content a hair more breathing room now that lasers are on the edge */
.heroInner{
  padding-top: 22px !important;
  padding-bottom: 22px !important;
}

  
</style>

  
  <!-- ==================================================================================================================
    =========================================================END OF STYLE=========================================================
  =================================================================================================================== -->

</head>
  <!-- ==================================================================================================================
    =========================================================START OF BODY=========================================================
  =================================================================================================================== -->
<body>
  <div class="wrap">

    <header class="heroBanner" aria-label="Navigation Hub banner">
      <div class="heroLaser heroLaserTop" aria-hidden="true"></div>

      <div class="heroInner">
        <div class="heroTop">
          <div class="heroDots" aria-label="Hero navigation">
            <a href="#top" class="navDot" aria-label="Top"></a>
            <a href="#treeRoot" class="navDot" aria-label="Navigation tree"></a>
            <a href="#notebook" class="navDot" aria-label="Task notebook"></a>
          </div>
        </div>

        <div class="heroCenter">
          <h1 class="heroTitle">Vigil</h1>
          <p class="heroSubtitle">Webpage Hub</p>
        </div>
      </div>

      <div class="heroLaser heroLaserBottom" aria-hidden="true"></div>
    </header>

    <div class="layout2">

      <!-- LEFT: Navigation -->
      <section class="card" aria-label="Navigation hub">
        <div class="toolbar" id="top">
          <div class="toolbarTitle">Webpage Navigation</div>

          <div class="toolbarCenter">
            <label class="sr-only" for="search">Search</label>
            <input class="input" id="search" type="search" placeholder="Search titles, URLs, notes, tasksâ€¦" />
          </div>

          <div class="toolbarRight">
            <button class="btn" id="addItem" type="button">ï¼‹ Add</button>

            <details class="menu" id="actionsMenu">
              <summary class="btn" aria-label="Actions">â˜° Actions</summary>
              <div class="menuList" role="menu" aria-label="Toolbar actions">
                <button class="btn menuItem" id="expandAll" type="button">â–¾ Expand all</button>
                <button class="btn menuItem" id="collapseAll" type="button">â–¸ Collapse all</button>
                <div class="menuSep"></div>
                <button class="btn menuItem" id="exportJson" type="button">â‡ª Export JSON</button>
                <button class="btn menuItem" id="resetEdits" type="button">â†º Reset edits</button>
              </div>
            </details>
          </div>
        </div>

        <div class="tree" id="treeRoot"></div>
      </section>

      <!-- RIGHT: Notebook -->
      <aside class="card notebook" id="notebook" aria-label="Task notebook">
        <div class="notebookHead">
          <div>
            <div class="kicker">TASK NOTEBOOK</div>
            <div class="notebookTitle" id="nbTitle">Selected task lists</div>
          </div>

          <div class="notebookTabs" role="tablist" aria-label="Notebook views">
            <button class="btn" id="nbTabSelected" type="button" aria-selected="true">Selected</button>
            <button class="btn" id="nbTabAll" type="button" aria-selected="false">All</button>
            <button class="btn" id="nbResetSelected" type="button" title="Clear selected task lists">â†º Reset</button>
          </div>
        </div>

        <div class="notebookBody" id="nbBody">
          <div class="taskEmpty">Click ðŸ§¾ on any page/link to pin its tasks here.</div>
        </div>
      </aside>

    </div>

    <!-- Embedded Data -->
    <script id="navData" type="application/json">
[
  { "type":"group", "id":"core", "title":"Core", "parentId":null, "order":1 },
  { "type":"tile",  "id":"home", "title":"Home", "href":"/index.html", "parentId":"core", "order":1 },

  { "type":"group", "id":"topics", "title":"Topics", "parentId":null, "order":2 },
  { "type":"group", "id":"animals", "title":"Animals", "parentId":"topics", "order":1, "color":"#22d3ee" },
  { "type":"tile",  "id":"animals-index", "title":"Animals", "href":"/animals/index.html", "parentId":"animals", "order":1 },
  { "type":"tile",  "id":"endangered", "title":"Endangered Animals", "href":"/animals/endangered.html", "parentId":"animals", "order":2 },

  { "type":"group", "id":"action", "title":"Take action", "parentId":null, "order":3 },
  { "type":"tile",  "id":"donate-wwf", "title":"Donate: WWF", "href":"https://www.worldwildlife.org/", "parentId":"action", "order":1 }
]
    </script>

    <!-- Add/Edit Modal -->
    <div class="modalBackdrop" id="modalBackdrop" hidden>
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modalHead">
          <div>
            <div class="kicker" id="modalKicker">ADD</div>
            <div id="modalTitle" class="modalTitle">Item</div>
          </div>
          <button class="iconBtn" id="closeModal" type="button" aria-label="Close">âœ•</button>
        </div>

        <div class="modalBody">
          <div class="grid2">
            <label class="field">
              <span>Type</span>
              <select class="input" id="fType">
                <option value="group">Page (group)</option>
                <option value="tile">Link (tile)</option>
              </select>
            </label>

            <label class="field">
              <span>Title</span>
              <input class="input" id="fTitle" placeholder="Title" />
            </label>
          </div>

          <label class="field">
            <span>Hyperlink</span>
            <input class="input" id="fHref" placeholder="https://â€¦ or /path" />
          </label>

          <label class="field">
            <span>WEBPAGE TASKS (one per line)</span>
            <textarea class="input" id="fTasks"
              placeholder="- Draft copy&#10;- Add donate buttons&#10;- Proofread"
              style="min-height:120px; resize:vertical; padding-top:10px;"></textarea>
          </label>

          <label class="field" id="groupColorField">
            <span>Group color</span>
            <input class="input" id="fColor" type="color" value="#6d5efc"
              style="height:44px; padding:6px 10px;" />
          </label>

          <div class="modalActions">
            <button class="btn" id="deleteItem" type="button">ðŸ—‘ Delete</button>
            <div style="flex:1"></div>
            <button class="btn" id="saveItem" type="button">ðŸ’¾ Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  </div>
</body>
<script>
/* =========================================================
  Vigil â€” Unlimited nesting tree (clean build)
========================================================== */

/* =========================================================
  1) STORAGE KEYS
========================================================== */
const LS_NODES = "vigil_nodes_tree_v1";
const LS_COLLAPSED = "vigil_collapsed_groups_v1";
const LS_TASK_SELECTED = "vigil_task_selected_v1";

/* =========================================================
  2) DOM HELPERS + REFERENCES
========================================================== */
const $ = (sel) => document.querySelector(sel);

const treeRootEl = $("#treeRoot");
const searchEl = $("#search");

const expandAllBtn = $("#expandAll");
const collapseAllBtn = $("#collapseAll");
const addItemBtn = $("#addItem");
const exportBtn = $("#exportJson");
const resetBtn = $("#resetEdits");

const actionsMenu = $("#actionsMenu");

const modalBackdrop = $("#modalBackdrop");
const closeModalBtn = $("#closeModal");
const saveItemBtn = $("#saveItem");
const deleteItemBtn = $("#deleteItem");

const modalKicker = $("#modalKicker");
const modalTitle = $("#modalTitle");

const fType = $("#fType");
const fTitle = $("#fTitle");
const fHref = $("#fHref");
const fTasks = $("#fTasks");
const fColor = $("#fColor");
const groupColorField = $("#groupColorField");

const nbTitle = $("#nbTitle");
const nbBody = $("#nbBody");
const nbTabSelected = $("#nbTabSelected");
const nbTabAll = $("#nbTabAll");
const nbResetSelected = $("#nbResetSelected");

/* =========================================================
  3) APP STATE
========================================================== */
let filter = "";
let editingId = null;

let notebookMode = "selected"; // "selected" | "all"
let selectedTaskIds = new Set();

let draftParentId = null;
let draftOrder = 9999;

let NODES = [];
let collapsedGroups = new Set();
let _sortables = [];

/* =========================================================
  4) UTILITIES
========================================================== */
const escapeHtml = (s) => (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const slugify = (s) => (s || "")
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/(^-|-$)/g, "");

const closeActionsMenu = () => {
  if (actionsMenu && actionsMenu.open) actionsMenu.open = false;
};

const copyToClipboard = async (text) => {
  try { await navigator.clipboard.writeText(text); } catch {}
};

/* =========================================================
  TASKS HELPERS
========================================================== */
const normalizeTasks = (node) => {
  if (typeof node.tasks === "string") node.tasks = [{ text: node.tasks, done:false }];
  if (!Array.isArray(node.tasks)) node.tasks = [];
};

const tasksToTextarea = (tasks) => {
  if (!Array.isArray(tasks) || !tasks.length) return "";
  return tasks.map(t => `${t?.done ? "[x] " : ""}${t?.text ?? ""}`.trimEnd()).join("\n");
};

const textareaToTasks = (value) => {
  const raw = (value || "").split("\n").map(s => s.trim()).filter(Boolean);
  return raw.map(line => {
    const done = /^\[x\]\s*/i.test(line) || /^-?\s*\[x\]\s*/i.test(line);
    const text = line
      .replace(/^-?\s*\[x\]\s*/i, "")
      .replace(/^\[x\]\s*/i, "")
      .replace(/^-+\s*/i, "")
      .trim();
    return { text, done };
  }).filter(t => t.text);
};

/* =========================================================
  5) LOAD / SAVE
========================================================== */
const loadEmbedded = () => {
  const el = document.getElementById("navData");
  return JSON.parse(el?.textContent || "[]");
};

const loadNodes = () => {
  const raw = localStorage.getItem(LS_NODES);
  if (raw) { try { return JSON.parse(raw); } catch {} }
  return loadEmbedded();
};

const saveNodes = () => localStorage.setItem(LS_NODES, JSON.stringify(NODES, null, 2));

const loadCollapsed = () => {
  const raw = localStorage.getItem(LS_COLLAPSED);
  if (!raw) return new Set();
  try { return new Set(JSON.parse(raw)); } catch { return new Set(); }
};

const saveCollapsed = () =>
  localStorage.setItem(LS_COLLAPSED, JSON.stringify([...collapsedGroups], null, 2));

const loadSelectedTasks = () => {
  const raw = localStorage.getItem(LS_TASK_SELECTED);
  if (!raw) return new Set();
  try { return new Set(JSON.parse(raw)); } catch { return new Set(); }
};

const saveSelectedTasks = () =>
  localStorage.setItem(LS_TASK_SELECTED, JSON.stringify([...selectedTaskIds], null, 2));

/* =========================================================
  6) DATA ACCESSORS
========================================================== */
const nodeById = (id) => NODES.find(n => n.id === id);

const childrenOf = (parentId) =>
  NODES
    .filter(n => (n.parentId ?? null) === (parentId ?? null))
    .sort((a,b) => (a.order ?? 0) - (b.order ?? 0));

const buildDescendantsSet = (groupId) => {
  const out = new Set();
  const stack = [groupId];
  while (stack.length) {
    const cur = stack.pop();
    for (const ch of childrenOf(cur)) {
      out.add(ch.id);
      if (ch.type === "group") stack.push(ch.id);
    }
  }
  return out;
};

const normalizeOrders = () => {
  const parents = new Set(NODES.map(n => n.parentId ?? null));
  for (const p of parents) {
    const kids = childrenOf(p);
    kids.forEach((n, idx) => (n.order = idx + 1));
  }
};

const accentForNode = (id) => {
  let cur = nodeById(id);
  while (cur) {
    if (cur.color) return cur.color;
    if (cur.parentId == null) break;
    cur = nodeById(cur.parentId);
  }
  return "";
};

/* =========================================================
  7) SEARCH / FILTER VISIBILITY
========================================================== */
const matchNode = (n) => {
  if (!filter) return true;
  normalizeTasks(n);
  const taskText = (n.tasks || []).map(t => t.text).join(" ");
  const hay = `${n.title||""} ${n.href||""} ${n.notes||""} ${taskText}`.toLowerCase();
  return hay.includes(filter);
};

const visibleSetForFilter = () => {
  if (!filter) return null;

  const visible = new Set();
  const byParent = new Map();

  for (const n of NODES) {
    const p = n.parentId ?? null;
    if (!byParent.has(p)) byParent.set(p, []);
    byParent.get(p).push(n);
  }

  const hasMatchInSubtree = (id) => {
    const n = nodeById(id);
    if (!n) return false;
    if (matchNode(n)) return true;
    if (n.type !== "group") return false;
    const kids = byParent.get(id) || [];
    return kids.some(k => hasMatchInSubtree(k.id));
  };

  const ensureAncestors = (id) => {
    let cur = nodeById(id);
    while (cur) {
      visible.add(cur.id);
      if (cur.parentId == null) break;
      cur = nodeById(cur.parentId);
    }
  };

  for (const n of NODES) {
    if (hasMatchInSubtree(n.id)) ensureAncestors(n.id);
  }

  return visible;
};

/* =========================================================
  8) MODAL: OPEN / CLOSE
========================================================== */
const showModal = () => modalBackdrop.removeAttribute("hidden");
const hideModal = () => modalBackdrop.setAttribute("hidden", "");

const setTypeUI = () => {
  const isGroup = fType.value === "group";
  groupColorField.style.display = isGroup ? "grid" : "none";
};

const openModal = (node, isNew, forceType = null) => {
  showModal();

  editingId = isNew ? null : node.id;
  draftParentId = isNew ? (node.parentId ?? null) : null;
  draftOrder = isNew ? (node.order ?? 9999) : 9999;

  modalKicker.textContent = isNew ? "ADD" : "EDIT";
  modalTitle.textContent = isNew ? "New item" : (node.title || node.id || "Item");

  fType.value = forceType ?? (node.type || "tile");
  setTypeUI();

  fTitle.value = node.title || "";
  fHref.value  = node.href  || "";
  fColor.value = node.color || "#6d5efc";

  normalizeTasks(node);
  fTasks.value = tasksToTextarea(node.tasks);

  deleteItemBtn.style.display = isNew ? "none" : "inline-flex";
  setTimeout(() => fTitle.focus(), 0);
};

const closeModal = () => {
  hideModal();
  editingId = null;
};

/* =========================================================
  9) CRUD
========================================================== */
const upsert = (updated) => {
  const idx = NODES.findIndex(x => x.id === updated.id);
  if (idx >= 0) NODES[idx] = { ...NODES[idx], ...updated };
  else NODES.push(updated);

  normalizeOrders();
  saveNodes();
  render();
};

const removeNode = (id) => {
  const n = nodeById(id);
  if (!n) return;

  const toDelete = new Set([id]);
  if (n.type === "group") {
    for (const d of buildDescendantsSet(id)) toDelete.add(d);
  }

  for (const x of toDelete) collapsedGroups.delete(x);
  selectedTaskIds.delete(id);

  NODES = NODES.filter(x => !toDelete.has(x.id));
  normalizeOrders();
  saveCollapsed();
  saveSelectedTasks();
  saveNodes();
  render();
};

/* =========================================================
  10) RENDER
========================================================== */
const renderAddButton = (parentId) => {
  const pid = parentId ?? null;
  return `
    <button class="dropHint" type="button"
      onclick="window.__addAt('${escapeHtml(pid ?? "__root__").replaceAll("'","&#039;")}')">
      ï¼‹ Add here
    </button>
  `;
};

window.__addAt = (parentRaw) => {
  const parentId = (parentRaw === "__root__") ? null : parentRaw;
  openModal({ type:"tile", id:"", title:"", href:"", parentId, notes:"", order:9999, tasks:[] }, true, null);
};

window.__openTasks = (id) => {
  if (selectedTaskIds.has(id)) selectedTaskIds.delete(id);
  else selectedTaskIds.add(id);
  saveSelectedTasks();
  render();
};

window.__taskAdd = (id) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const text = prompt("New task:");
  if (!text || !text.trim()) return;
  n.tasks.push({ text: text.trim(), done:false });
  saveNodes();
  render();
};

window.__taskToggle = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  const t = n.tasks[idx];
  if (!t) return;
  t.done = !t.done;
  saveNodes();
  render();
};

window.__taskDelete = (id, idx) => {
  const n = nodeById(id);
  if (!n) return;
  normalizeTasks(n);
  n.tasks.splice(idx, 1);
  saveNodes();
  render();
};

const renderTile = (n) => {
  const chip = `<span class="chip">Link</span>`;
  const notes = n.notes ? `<div class="notes">${escapeHtml(n.notes)}</div>` : "";
  const href = n.href || "#";
  const target = href.startsWith("/") ? "" : `target="_blank" rel="noreferrer noopener"`;

  return `
    <div class="tile treeItem" data-id="${escapeHtml(n.id)}" data-type="tile">
      <div class="tileMain">
        <a href="${escapeHtml(href)}" ${target} style="text-decoration:none; color:inherit;">
          <div class="tileTitleLine">
            <span class="tileTitle">${escapeHtml(n.title || "(untitled)")}</span>
            ${chip}
          </div>
        </a>
        ${notes}
      </div>

      <div class="actions">
        <button class="iconBtn ${selectedTaskIds.has(n.id) ? "active" : ""}" type="button"
          onclick="window.__openTasks('${escapeHtml(n.id).replaceAll("'","&#039;")}')"
          aria-label="Toggle tasks">ðŸ§¾</button>

        <button class="iconBtn" type="button"
          onclick="window.__edit('${escapeHtml(n.id).replaceAll("'","&#039;")}')">âœŽ</button>

        <button class="iconBtn" type="button"
          onclick="window.__copy('${escapeHtml(href).replaceAll("'","&#039;")}', '${escapeHtml(n.title||"").replaceAll("'","&#039;")}')">â§‰</button>

        <div class="dragHandle" role="button" tabindex="0" aria-label="Drag to move tile" title="Drag to move">â‹®â‹®</div>
      </div>
    </div>
  `;
};

const renderGroup = (g, visibleSet, depth) => {
  const kids = childrenOf(g.id).filter(n => !visibleSet || visibleSet.has(n.id));
  const collapsed = collapsedGroups.has(g.id) && !filter;
  const indentClass = depth > 0 ? "indent" : "";

  const accentAttr = g.color
    ? `data-accent="1" style="--accentStrip:${escapeHtml(g.color)};"`
    : "";

  const body = collapsed ? "" : (
    kids.length
      ? kids.map(n => n.type === "group"
          ? renderGroup(n, visibleSet, depth + 1)
          : renderTile(n)
        ).join("")
      : `${renderAddButton(g.id)}`
  );

  const headerTitle = (() => {
    const title = escapeHtml(g.title || "(group)");
    const href = g.href;
    if (!href) return `<div class="nodeTitle">${title}</div>`;
    const target = href.startsWith("/") ? "" : `target="_blank" rel="noreferrer noopener"`;
    return `<a class="nodeTitle" href="${escapeHtml(href)}" ${target} style="text-decoration:none; color:inherit;">${title}</a>`;
  })();

  return `
    <div class="node treeItem ${indentClass}" data-id="${escapeHtml(g.id)}" data-type="group" ${accentAttr}>
      <div class="nodeHeader">
        <div class="nodeHeaderLeft">
          <button class="twisty" type="button" aria-label="Toggle group"
            onclick="window.__toggle('${escapeHtml(g.id).replaceAll("'","&#039;")}')">
            ${collapsed ? "â–¸" : "â–¾"}
          </button>

          <div style="min-width:0">
            ${headerTitle}
            ${g.notes ? `<div class="notes" style="margin-top:2px">${escapeHtml(g.notes)}</div>` : ``}
          </div>
        </div>

        <div class="actions">
          <button class="iconBtn ${selectedTaskIds.has(g.id) ? "active" : ""}" type="button"
            onclick="window.__openTasks('${escapeHtml(g.id).replaceAll("'","&#039;")}')"
            aria-label="Toggle tasks">ðŸ§¾</button>

          <button class="iconBtn" type="button"
            onclick="window.__edit('${escapeHtml(g.id).replaceAll("'","&#039;")}')">âœŽ</button>

          <button class="iconBtn" type="button"
            onclick="window.__copy('${escapeHtml(g.href||"").replaceAll("'","&#039;")}', '${escapeHtml(g.title||"").replaceAll("'","&#039;")}')">â§‰</button>

          <div class="dragHandle" role="button" tabindex="0" aria-label="Drag to move group" title="Drag to move">â‹®â‹®</div>
        </div>
      </div>

      <div class="nodeBody" ${collapsed ? "hidden" : ""} data-container="children" data-parent-id="${escapeHtml(g.id)}">
        ${body}
        ${(!collapsed && kids.length) ? `${renderAddButton(g.id)}` : ``}
      </div>
    </div>
  `;
};

const renderRoot = () => {
  const visibleSet = visibleSetForFilter();
  const roots = childrenOf(null).filter(n => !visibleSet || visibleSet.has(n.id));

  if (!roots.length) {
    treeRootEl.innerHTML = `
      <div class="dropHint">No matches. Try a different search.</div>
      ${renderAddButton(null)}
    `;
    return;
  }

  treeRootEl.innerHTML = `
    <div data-container="children" data-parent-id="__root__">
      ${roots.map(n => n.type === "group" ? renderGroup(n, visibleSet, 0) : renderTile(n)).join("")}
    </div>
  `;
};

/* =========================================================
  NOTEBOOK RENDER
========================================================== */
const renderNotebookSelected = () => {
  const ids = [...selectedTaskIds].filter(id => nodeById(id));

  if (!ids.length) {
    nbTitle.textContent = "Selected task lists";
    nbBody.innerHTML = `<div class="taskEmpty">Toggle ðŸ§¾ on any page/link to show its tasks here.</div>`;
    return;
  }

  nbTitle.textContent = `Selected task lists (${ids.length})`;

  nbBody.innerHTML = ids.map((id) => {
    const n = nodeById(id);
    normalizeTasks(n);

    const accent = accentForNode(n.id);
    const accentAttr = accent ? `data-accent="1" style="--accentStrip:${escapeHtml(accent)};"` : "";

    const tasks = n.tasks || [];
    const rows = tasks.length
      ? `<div class="taskList">${
          tasks.map((t, idx) => `
            <div class="taskRow">
              <input class="taskCheck" type="checkbox"
                ${t.done ? "checked" : ""}
                onclick="window.__taskToggle('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
                aria-label="Mark task done" />
              <div class="taskText ${t.done ? "done" : ""}">${escapeHtml(t.text)}</div>
              <button class="taskDel" type="button"
                onclick="window.__taskDelete('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
                aria-label="Delete task">âœ•</button>
            </div>
          `).join("")
        }</div>`
      : `<div class="taskEmpty">No tasks yet.</div>`;

    return `
      <div class="tasks" ${accentAttr} aria-label="Webpage tasks">
        <div class="tasksHead">
          <div class="tasksLabel">${escapeHtml(n.title || n.id)}</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="tasksAdd" type="button"
              onclick="window.__taskAdd('${escapeHtml(n.id).replaceAll("'","&#039;")}')">ï¼‹ Add task</button>
            <button class="tasksAdd" type="button"
              onclick="window.__openTasks('${escapeHtml(n.id).replaceAll("'","&#039;")}')">âœ• Hide</button>
          </div>
        </div>
        ${rows}
      </div>
    `;
  }).join("");
};

const renderNotebookAll = () => {
  const nodesWithTasks = NODES
    .map(n => (normalizeTasks(n), n))
    .filter(n => Array.isArray(n.tasks) && n.tasks.length);

  nbTitle.textContent = "All tasks (across site)";

  if (!nodesWithTasks.length) {
    nbBody.innerHTML = `<div class="taskEmpty">No tasks found yet.</div>`;
    return;
  }

  nbBody.innerHTML = nodesWithTasks.map(n => `
    <div class="tasks" aria-label="Webpage tasks">
      <div class="tasksHead">
        <div class="tasksLabel">${escapeHtml(n.title || n.id)}</div>
        <button class="tasksAdd" type="button"
          onclick="window.__taskAdd('${escapeHtml(n.id).replaceAll("'","&#039;")}')">ï¼‹ Add task</button>
      </div>
      <div class="taskList">
        ${n.tasks.map((t, idx) => `
          <div class="taskRow">
            <input class="taskCheck" type="checkbox"
              ${t.done ? "checked" : ""}
              onclick="window.__taskToggle('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Mark task done" />
            <div class="taskText ${t.done ? "done" : ""}">${escapeHtml(t.text)}</div>
            <button class="taskDel" type="button"
              onclick="window.__taskDelete('${escapeHtml(n.id).replaceAll("'","&#039;")}', ${idx})"
              aria-label="Delete task">âœ•</button>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
};

const renderNotebook = () => {
  nbTabSelected.setAttribute("aria-selected", notebookMode === "selected");
  nbTabAll.setAttribute("aria-selected", notebookMode === "all");
  if (notebookMode === "selected") renderNotebookSelected();
  else renderNotebookAll();
};

/* =========================================================
  SORTABLE
========================================================== */
const destroySortables = () => {
  _sortables.forEach(s => { try { s.destroy(); } catch {} });
  _sortables = [];
};

const rebuildFromDOM = () => {
  document.querySelectorAll('[data-container="children"]').forEach((containerEl) => {
    const p = containerEl.dataset.parentId;
    const parentId = (p === "__root__") ? null : p;

    const items = [...containerEl.children].filter(el => el.classList.contains("treeItem"));
    items.forEach((el, idx) => {
      const id = el.dataset.id;
      const n = nodeById(id);
      if (!n) return;
      n.parentId = parentId;
      n.order = idx + 1;
    });
  });

  normalizeOrders();
  saveNodes();
};

const isDescendant = (maybeChildId, maybeAncestorId) =>
  buildDescendantsSet(maybeAncestorId).has(maybeChildId);

const initSortables = () => {
  destroySortables();

  document.querySelectorAll('[data-container="children"]').forEach((containerEl) => {
    const s = new Sortable(containerEl, {
      group: "vigil-tree",
      animation: 150,
      draggable: ".treeItem",
      handle: ".dragHandle",
      filter: "a, button",
      preventOnFilter: true,
      fallbackOnBody: true,

      onMove: (evt) => {
        const draggedId = evt.dragged?.dataset?.id;
        const draggedType = evt.dragged?.dataset?.type;

        const toParentRaw = evt.to?.dataset?.parentId;
        const toParentId = (toParentRaw === "__root__") ? null : toParentRaw;

        if (!draggedId) return true;
        if (toParentId === draggedId) return false; // into itself

        if (draggedType === "group" && toParentId) {
          if (isDescendant(toParentId, draggedId)) return false; // into own descendant
        }
        return true;
      },

      onEnd: () => {
        rebuildFromDOM();
        render();
      }
    });

    _sortables.push(s);
  });
};

/* =========================================================
  RENDER PIPELINE
========================================================== */
const render = () => {
  renderRoot();
  initSortables();
  renderNotebook();
};

/* =========================================================
  PUBLIC HOOKS
========================================================== */
window.__toggle = (groupId) => {
  if (collapsedGroups.has(groupId)) collapsedGroups.delete(groupId);
  else collapsedGroups.add(groupId);
  saveCollapsed();
  render();
};

window.__copy = (href, title) => {
  if (!href) return;
  const html = `<a href="${href}" target="_blank" rel="noopener noreferrer">${title || href}</a>`;
  copyToClipboard(html);
};

window.__edit = (id) => {
  const n = nodeById(id);
  if (!n) return;
  openModal(n, false);
};

/* =========================================================
  UI ACTIONS
========================================================== */
const setAllCollapsed = (collapsed) => {
  const allGroups = NODES.filter(n => n.type === "group").map(n => n.id);
  collapsedGroups = new Set(collapsed ? allGroups : []);
  saveCollapsed();
  render();
};

/* =========================================================
  EVENTS
========================================================== */
nbTabSelected.addEventListener("click", () => { notebookMode = "selected"; render(); });
nbTabAll.addEventListener("click", () => { notebookMode = "all"; render(); });

nbResetSelected.addEventListener("click", () => {
  selectedTaskIds.clear();
  saveSelectedTasks();
  render();
});

searchEl.addEventListener("input", (e) => {
  filter = (e.target.value || "").trim().toLowerCase();
  render();
});

expandAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(false); });
collapseAllBtn.addEventListener("click", () => { closeActionsMenu(); setAllCollapsed(true); });

exportBtn.addEventListener("click", async () => {
  closeActionsMenu();
  const json = JSON.stringify(NODES, null, 2);
  try {
    await navigator.clipboard.writeText(json);
    alert("Copied tree JSON to clipboard.");
  } catch {
    console.log(json);
    alert("Could not copy automatically. Check console for JSON.");
  }
});

resetBtn.addEventListener("click", () => {
  closeActionsMenu();
  if (!confirm("Clear saved edits on this device?")) return;
  localStorage.removeItem(LS_NODES);
  localStorage.removeItem(LS_COLLAPSED);
  localStorage.removeItem(LS_TASK_SELECTED);
  location.reload();
});

document.addEventListener("click", (e) => {
  if (actionsMenu?.open && !actionsMenu.contains(e.target)) actionsMenu.open = false;
});

// Global add
addItemBtn.addEventListener("click", () => {
  openModal({ type:"tile", id:"", title:"", href:"", parentId:null, notes:"", order:9999, tasks:[] }, true, null);
});

// Modal close
closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !modalBackdrop.hasAttribute("hidden")) closeModal();
});

fType.addEventListener("change", setTypeUI);

// Save modal
saveItemBtn.addEventListener("click", () => {
  const type  = (fType.value || "tile").trim();
  const title = (fTitle.value || "").trim();
  const href  = (fHref.value || "").trim();
  const color = (fColor?.value || "").trim();

  if (!title) return alert("Title is required.");
  if (!href)  return alert("Hyperlink is required.");

  let id = editingId ? editingId : (slugify(title) || "item");

  if (!editingId) {
    const base = id;
    let n = 2;
    while (NODES.some(x => x.id === id)) id = `${base}-${n++}`;
  }

  const existing = nodeById(id);

  const updated = {
    id,
    type,
    title,
    href,
    parentId: existing?.parentId ?? draftParentId ?? null,
    order: existing?.order ?? draftOrder ?? 9999,
    tasks: textareaToTasks(fTasks.value),
  };

  if (type === "group") updated.color = color || "#6d5efc";
  else delete updated.color;

  upsert(updated);
  closeModal();
});

// Delete modal
deleteItemBtn.addEventListener("click", () => {
  if (!editingId) return;
  if (!confirm("Delete this item? (Groups delete their entire subtree)")) return;
  removeNode(editingId);
  closeModal();
});

/* =========================================================
  BOOT
========================================================== */
NODES = loadNodes();
collapsedGroups = loadCollapsed();
selectedTaskIds = loadSelectedTasks();

NODES.forEach(normalizeTasks);
normalizeOrders();
saveNodes();
setTypeUI();
render();
</script>

</body>
 <!-- ==================================================================================================================
    =========================================================END OF BODY=========================================================
  =================================================================================================================== -->
</html>
